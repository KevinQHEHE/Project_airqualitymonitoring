<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Admin Dashboard - User Management</title>

  <!-- Fonts and icons (same as dashboard) -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files (same as dashboard) -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/theme-switcher.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/admin_dashboard.css') }}" rel="stylesheet" />
</head>

<body class="">
  <div class="admin-wrapper">
    <!-- Navbar (similar to dashboard) -->
    <nav class="navbar navbar-expand-lg navbar-absolute" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div class="container-fluid">
        <div class="navbar-wrapper">
          <a class="navbar-brand text-white" href="/">
            <i class="fas fa-tachometer-alt me-2"></i>
            Air Quality Monitor
          </a>
        </div>
        <div class="navbar-nav ms-auto">
          <!-- Theme Toggle Switch -->
          <div class="nav-item me-3">
            <div class="form-check form-switch d-flex align-items-center">
              <input class="form-check-input" type="checkbox" id="themeToggle" checked>
              <label class="form-check-label text-white ms-2" for="themeToggle">
                <i class="fas fa-moon" id="themeIcon"></i>
              </label>
            </div>
          </div>
          
          <a class="nav-link text-white" href="/">
            <i class="fas fa-home me-1"></i>Dashboard
          </a>
          <a class="nav-link text-white" href="/reports">
            <i class="fas fa-chart-bar me-1"></i>Reports  
          </a>
          <a class="nav-link text-white" href="/admin">
            <i class="fas fa-users me-1"></i>Admin
          </a>
          <a class="nav-link text-white" href="/login">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-content">
      <div class="container-fluid py-4">
        <!-- Header -->
        <div class="admin-header">
          <div class="row">
            <div class="col-8">
              <h1><i class="fas fa-users me-2"></i>User Management</h1>
              <p class="mb-0">Quản lý người dùng và hệ thống</p>
            </div>
            <div class="col-4 text-end">
              <!-- Simple auth section for API testing -->
              <div class="d-flex align-items-center justify-content-end">
                <small id="authStatus" class="text-white-50 me-3">Chưa đăng nhập</small>
                <a id="createUserBtn" class="btn btn-sm btn-success me-2" href="/admin/users/add" title="Tạo người dùng mới">
                  <i class="fas fa-user-plus me-1"></i> Tạo người dùng
                </a>
                <!-- login button removed as requested -->
                <button id="logoutBtn" class="btn btn-sm btn-outline-secondary" onclick="logout()" style="display: none;">Đăng xuất</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-header">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="userSearch" class="form-label text-white-50">Tìm kiếm người dùng</label>
              <input type="text" class="form-control" id="userSearch" placeholder="Tên, email hoặc ID...">
            </div>
            <!-- Removed status and sort controls to simplify search header -->
            <div class="col-md-2">
              <button type="button" class="btn btn-primary w-100" id="searchBtn">
                <i class="fas fa-search me-1"></i>Tìm kiếm
              </button>
            </div>
          </div>
        </div>

        <!-- User Table -->
        <div class="admin-card">
          <div class="card-body p-0">
            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span id="selectedCount">0</span> người dùng được chọn
                </div>
                <div class="btn-group">
                  <button class="btn btn-outline-light btn-sm bulk-action-btn" onclick="bulkChangeStatus()">
                    <i class="fas fa-exchange-alt me-1"></i>Chuyển trạng thái
                  </button>
                  <button class="btn btn-outline-light btn-sm bulk-action-btn" onclick="bulkExport()">
                    <i class="fas fa-download me-1"></i>Xuất dữ liệu
                  </button>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table id="userTable" class="table table-dark table-hover mb-0">
                <thead>
                  <tr>
                    <th scope="col" width="5%">
                      <input class="form-check-input" type="checkbox" id="selectAllUsers">
                    </th>
                    <th scope="col" width="30%">Thông tin</th>
                    <th scope="col" width="15%">Vai trò</th>
                    <th scope="col" width="15%">Trạng thái</th>
                    <th scope="col" width="20%">Ngày tham gia / Đăng nhập</th>
                    <th scope="col" width="10%">Thao tác</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <!-- Mock data will be inserted here by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
                  <div class="d-flex justify-content-between align-items-center p-3">
              <div id="showingInfo" class="showing-info text-white-50">Hiển thị 0 người dùng</div>
              <div id="paginationContainer"></div>
            </div>
          </div>
        </div>

        <!-- User Detail Modal -->
        <div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="userDetailModalLabel">
                  <i class="fas fa-user me-2"></i>Chi tiết người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="userDetailTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab">
                      <i class="fas fa-user me-1"></i>Thông tin cơ bản
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                      <i class="fas fa-bell me-1"></i>Cảnh báo
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3" id="userDetailTabContent">
                  <!-- Basic Info Tab -->
                  <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
                    <div id="basicInfoContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- Locations Tab -->
                  <div class="tab-pane fade" id="locations" role="tabpanel">
                    <div id="locationsContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- Alerts Tab -->
                  <div class="tab-pane fade" id="alerts" role="tabpanel">
                    <div id="alertsContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- (Removed Subscriptions & Activity panes per admin simplification) -->
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Đóng</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                  <i class="fas fa-edit me-2"></i>Chỉnh sửa người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editUserForm">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="editUserName" class="form-label">Họ tên</label>
                      <input type="text" class="form-control" id="editUserName" required>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserEmail" class="form-label">Email</label>
                      <input type="email" class="form-control" id="editUserEmail" required>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserRole" class="form-label">Vai trò</label>
                      <select class="form-select" id="editUserRole" required>
                        <option value="user">User</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserStatus" class="form-label">Trạng thái</label>
                      <select class="form-select" id="editUserStatus" required>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Không hoạt động</option>
                        <!-- suspended option removed -->
                      </select>
                    </div>
                    <div class="col-12">
                      <div class="row">
                        <div class="col-md-6">
                          <label class="form-label">Ngày tham gia</label>
                          <input type="text" class="form-control" id="editUserCreated" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Đăng nhập cuối</label>
                          <input type="text" class="form-control" id="editUserLastLogin" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="saveUserChanges()">
                  <i class="fas fa-save me-1"></i>Lưu thay đổi
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Spinner removed to avoid accidental overlay blocking interaction.
             If needed, re-add and use JS to toggle a `.show` class on the element. -->

        <!-- Toast Container -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
            <div class="toast-header">
              <i class="fas fa-info-circle text-primary me-2"></i>
              <strong class="me-auto">Thông báo</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
              <!-- Toast message will be set by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Scripts -->
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script>
    console.log('jQuery loaded (local):', typeof window.jQuery !== 'undefined');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load black-dashboard after jQuery is available to avoid `$ is not defined` errors -->
  <script>
    (function loadBlackDashboard(retries) {
      retries = retries || 0;
      if (typeof window.jQuery !== 'undefined' || retries > 10) {
        var script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}";
        script.onload = function() { console.log('black-dashboard.min.js loaded'); };
        script.onerror = function() {
          console.error('Failed to load black-dashboard.min.js');
        };
        document.body.appendChild(script);
      } else {
        // Retry after a short delay
        setTimeout(function() { loadBlackDashboard(retries + 1); }, 100);
      }
    })();
  </script>

  <!-- Admin class-based script (optional) -->
  <script src="{{ url_for('static', filename='js/assets/admin_user_management.js') }}"></script>

  <!-- Small theme initializer: active script so admin theme toggle works even though
       the older inline logic is intentionally disabled elsewhere. Keeps behavior
       consistent with other pages (stores 'adminTheme' in localStorage). -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const adminWrapper = document.querySelector('.admin-wrapper');
        const bodyEl = document.body;
        if (!themeToggle || !themeIcon || !adminWrapper || !bodyEl) return;

        const savedTheme = localStorage.getItem('adminTheme');
        const applyLight = (savedTheme === 'light');
        if (applyLight) {
          adminWrapper.classList.add('light-mode');
          bodyEl.classList.add('white-content');
          themeToggle.checked = false;
          themeIcon.className = 'fas fa-moon';
        } else {
          adminWrapper.classList.remove('light-mode');
          bodyEl.classList.remove('white-content');
          themeToggle.checked = true;
          themeIcon.className = 'fas fa-sun';
        }

        themeToggle.addEventListener('change', function() {
          if (this.checked) {
            // dark mode
            adminWrapper.classList.remove('light-mode');
            bodyEl.classList.remove('white-content');
            themeIcon.className = 'fas fa-sun';
            localStorage.setItem('adminTheme', 'dark');
          } else {
            // light mode
            adminWrapper.classList.add('light-mode');
            bodyEl.classList.add('white-content');
            themeIcon.className = 'fas fa-moon';
            localStorage.setItem('adminTheme', 'light');
          }
        });
      } catch (e) {
        console.error('Theme init error:', e);
      }
    });
  </script>

  <script>
    // ===== USE ADMIN CLASS ONLY - INLINE SCRIPT DISABLED =====
    // All mock data and table functions moved to AdminUserManagement class
    
    if (false) { // This entire block is disabled
    // Mock Data - Beautiful sample users
    const mockUsers = [
      {
        id: 1,
        name: "Nguyễn Văn Admin",
        email: "admin@aqimonitor.vn",
        avatar: null,
        status: "active",
        role: "admin",
        created_at: "2024-01-15T08:30:00Z",
        last_login: "2025-09-22T10:15:00Z",
        favorite_locations: [
          { name: "Hà Nội", coordinates: [21.0285, 105.8542], alerts_enabled: true },
          { name: "TP.HCM", coordinates: [10.8231, 106.6297], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "AQI", threshold: 100, enabled: true },
          { type: "PM2.5", threshold: 50, enabled: true }
        ],
        login_count: 245,
        reports_generated: 12
      },
      {
        id: 2,
        name: "Trần Thị Minh",
        email: "minh.tran@email.com",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-02-10T14:20:00Z",
        last_login: "2025-09-21T16:45:00Z",
        favorite_locations: [
          { name: "Đà Nẵng", coordinates: [16.0544, 108.2022], alerts_enabled: true },
          { name: "Hội An", coordinates: [15.8801, 108.338], alerts_enabled: false }
        ],
        alert_settings: [
          { type: "AQI", threshold: 150, enabled: true }
        ],
        login_count: 89,
        reports_generated: 3
      },
      {
        id: 3,
        name: "Lê Hoàng Nam",
        email: "nam.le@company.vn",
        avatar: null,
        status: "inactive",
        role: "user",
        created_at: "2024-03-05T09:15:00Z",
        last_login: "2025-09-15T08:30:00Z",
        favorite_locations: [
          { name: "Cần Thơ", coordinates: [10.0452, 105.7469], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "PM2.5", threshold: 75, enabled: true },
          { type: "PM10", threshold: 100, enabled: false }
        ],
        login_count: 156,
        reports_generated: 7
      },
      {
        id: 4,
        name: "Phạm Thị Hoa",
        email: "hoa.pham@gmail.com",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-04-12T11:45:00Z",
        last_login: "2025-09-22T09:20:00Z",
        favorite_locations: [
          { name: "Huế", coordinates: [16.4637, 107.5909], alerts_enabled: true },
          { name: "Quảng Ninh", coordinates: [20.9588, 107.0428], alerts_enabled: true },
          { name: "Hà Long", coordinates: [20.9101, 107.1839], alerts_enabled: false }
        ],
        alert_settings: [
          { type: "AQI", threshold: 120, enabled: true }
        ],
        login_count: 67,
        reports_generated: 5
      },
      {
        id: 5,
        name: "Võ Minh Quang",
        email: "quang.vo@tech.vn",
        avatar: null,
        status: "inactive",
        role: "user",
        created_at: "2024-05-20T16:30:00Z",
        last_login: "2025-09-10T14:15:00Z",
        favorite_locations: [
          { name: "Nha Trang", coordinates: [12.2388, 109.1967], alerts_enabled: false }
        ],
        alert_settings: [],
        login_count: 23,
        reports_generated: 1
      },
      {
        id: 6,
        name: "Đỗ Thị Lan",
        email: "lan.do@university.edu.vn",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-06-18T13:25:00Z",
        last_login: "2025-09-21T18:30:00Z",
        favorite_locations: [
          { name: "Vũng Tàu", coordinates: [10.4113, 107.1441], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "PM2.5", threshold: 60, enabled: true }
        ],
        login_count: 112,
        reports_generated: 8
      }
    ];

    let currentPage = 1;
    let itemsPerPage = 5;
    let filteredUsers = [...mockUsers];
    let selectedUsers = new Set();

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[user_management.html inline script] DOMContentLoaded - initializing inline logic');
      renderUserTable();
      setupEventListeners();
      initializeTheme();
    });

    function initializeTheme() {
      // Check if user has a saved theme preference
      const savedTheme = localStorage.getItem('adminTheme');
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      if (savedTheme === 'light') {
        document.querySelector('.admin-wrapper').classList.add('light-mode');
        themeToggle.checked = false;
        themeIcon.className = 'fas fa-moon'; // Show moon in light mode (to switch to dark)
      } else {
        themeToggle.checked = true;
        themeIcon.className = 'fas fa-sun'; // Show sun in dark mode (to switch to light)
      }

      // Add event listener for theme toggle
      themeToggle.addEventListener('change', toggleTheme);
    }

    function toggleTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const adminWrapper = document.querySelector('.admin-wrapper');

      if (themeToggle.checked) {
        // Dark mode
        adminWrapper.classList.remove('light-mode');
        themeIcon.className = 'fas fa-sun'; // Show sun in dark mode (to switch to light)
        localStorage.setItem('adminTheme', 'dark');
        showToast('Đã chuyển sang chế độ tối', 'info');
      } else {
        // Light mode
        adminWrapper.classList.add('light-mode');
        themeIcon.className = 'fas fa-moon'; // Show moon in light mode (to switch to dark)
        localStorage.setItem('adminTheme', 'light');
        showToast('Đã chuyển sang chế độ sáng', 'info');
      }
    }

    function setupEventListeners() {
      // Search input
      document.getElementById('searchUser').addEventListener('input', debounce(applyFilters, 300));
      
      // Filter dropdowns
      document.getElementById('filterStatus').addEventListener('change', applyFilters);
  const filterRoleEl = document.getElementById('filterRole');
  if (filterRoleEl) filterRoleEl.addEventListener('change', applyFilters);
      document.getElementById('sortBy').addEventListener('change', applyFilters);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function applyFilters() {
      const searchTerm = document.getElementById('searchUser').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
  const roleFilter = (document.getElementById('filterRole') && document.getElementById('filterRole').value) || '';
      const sortBy = document.getElementById('sortBy').value;

      // Filter users
      filteredUsers = mockUsers.filter(user => {
        const matchesSearch = !searchTerm || 
          user.name.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm) ||
          user.id.toString().includes(searchTerm);
        
        const matchesStatus = !statusFilter || user.status === statusFilter;
        const matchesRole = !roleFilter || user.role === roleFilter;

        return matchesSearch && matchesStatus && matchesRole;
      });

      // Sort users
      switch(sortBy) {
        case 'created_asc':
          filteredUsers.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          break;
        case 'created_desc':
          filteredUsers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
        case 'name_asc':
          filteredUsers.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'name_desc':
          filteredUsers.sort((a, b) => b.name.localeCompare(a.name));
          break;
      }

      currentPage = 1;
      renderUserTable();
    }

    // Load users function (alias for renderUserTable)
    function loadUsers() {
      renderUserTable();
    }

    function renderUserTable() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageUsers = filteredUsers.slice(startIndex, endIndex);

      const tableBody = document.getElementById('userTableBody');
      tableBody.innerHTML = '';

      pageUsers.forEach(user => {
        const row = createUserRow(user);
        tableBody.appendChild(row);
      });

      updatePagination();
      updateShowingInfo();
    }

    function createUserRow(user) {
      const row = document.createElement('tr');
      
  // Status badge
  // Normalize to only two visible states: 'active' and 'inactive'
  const normalizedStatus = user.status === 'active' ? 'active' : 'inactive';
      const statusClass = {
        'active': 'bg-success',
        'inactive': 'bg-warning text-dark'
      }[normalizedStatus] || 'bg-secondary';

      const statusText = {
        'active': 'Hoạt động',
        'inactive': 'Không hoạt động'
      }[normalizedStatus] || 'Không xác định';

      // Role badge
      const roleClass = {
        'admin': 'bg-primary',
        'user': 'bg-info text-dark'
      }[user.role] || 'bg-secondary';

      const roleText = {
        'admin': 'Admin',
        'user': 'User'
      }[user.role] || 'Unknown';

      // Avatar initials
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      // Format dates
      const createdDate = new Date(user.created_at).toLocaleDateString('vi-VN');
      const lastLoginDate = new Date(user.last_login).toLocaleDateString('vi-VN');

      row.innerHTML = `
        <td>
          <input class="form-check-input user-checkbox" type="checkbox" value="${user.id}" onchange="toggleUserSelection(${user.id})">
        </td>
        <td>
          <div>
            <strong class="text-white">${user.name}</strong>
            <br>
            <small class="text-white-50">${user.email}</small>
          </div>
        </td>
        <td>
          <span class="badge ${roleClass}">${roleText}</span>
        </td>
        <td>
          <span class="badge ${statusClass}">${statusText}</span>
        </td>
        <td>
          <span class="text-white">${createdDate}</span>
        </td>
        
        <td>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails(${user.id})" title="Xem chi tiết">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </td>
      `;

      return row;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      const paginationNav = document.getElementById('paginationNav');
      
      paginationNav.innerHTML = '';

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Trước</a>`;
      paginationNav.appendChild(prevLi);

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationNav.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Tiếp</a>`;
      paginationNav.appendChild(nextLi);
    }

    function updateShowingInfo() {
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, filteredUsers.length);
      
      document.getElementById('showingStart').textContent = filteredUsers.length > 0 ? startIndex : 0;
      document.getElementById('showingEnd').textContent = endIndex;
      document.getElementById('totalUsers').textContent = filteredUsers.length;
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderUserTable();
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllUsers');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      
      selectedUsers.clear();
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
          selectedUsers.add(parseInt(checkbox.value));
        }
      });
      
      updateBulkActions();
    }

    function toggleUserSelection(userId) {
      if (selectedUsers.has(userId)) {
        selectedUsers.delete(userId);
      } else {
        selectedUsers.add(userId);
      }
      
      // Update select all checkbox
  const selectAll = document.getElementById('selectAllUsers');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      selectAll.checked = selectedUsers.size === checkboxes.length;
      selectAll.indeterminate = selectedUsers.size > 0 && selectedUsers.size < checkboxes.length;
      
      updateBulkActions();
    }

    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      if (selectedUsers.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedUsers.size;
      } else {
        bulkActions.classList.remove('show');
      }
    }

    function deleteUser(userId) {
      // Deletion is disabled in this UI. Use admin API or backend tools for permanent deletion.
      alert('Chức năng xóa người dùng đã bị tắt trong giao diện. Vui lòng sử dụng API hoặc công cụ quản trị để xóa người dùng.');
    }

    function viewUserDetails(userId) {
      const user = mockUsers.find(u => u.id === userId);
      if (!user) return;

      // Store user ID in modal for later use
      const modal = document.getElementById('userDetailModal');
      modal.dataset.userId = userId;

      // Update modal title
      document.getElementById('userDetailModalLabel').innerHTML = 
        `<i class="fas fa-user me-2"></i>Chi tiết: ${user.name}`;

  // Load basic info
  loadBasicInfo(user);
  // Load alerts (will include subscriptions and threshold bars)
  loadUserAlerts(user);

      // Show modal
      const modalInstance = new bootstrap.Modal(modal);
      modalInstance.show();
    }

    function loadBasicInfo(user) {
      const content = document.getElementById('basicInfoContent');
      // Use normalized status so UI only displays the two allowed states
      const normalizedStatus = user.status === 'active' ? 'active' : 'inactive';
      const statusText = {
        'active': 'Hoạt động',
        'inactive': 'Không hoạt động'
      }[normalizedStatus];

      const roleText = {
        'admin': 'Quản trị viên',
        'user': 'Người dùng'
      }[user.role];

      content.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">ID:</div>
              <div class="user-info-value">#${user.id}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Họ tên:</div>
              <div class="user-info-value">${user.name}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Email:</div>
              <div class="user-info-value">${user.email}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Trạng thái:</div>
              <div class="user-info-value">${statusText}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Vai trò:</div>
              <div class="user-info-value">${roleText}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Ngày tham gia:</div>
              <div class="user-info-value">${new Date(user.created_at).toLocaleDateString('vi-VN')}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Đăng nhập cuối:</div>
              <div class="user-info-value">${new Date(user.last_login).toLocaleDateString('vi-VN')}</div>
            </div>
          </div>
          <!-- Số lần đăng nhập removed per admin simplification -->
        </div>
      `;
    }

    function loadUserLocations(user) {
      const content = document.getElementById('locationsContent');
      
      if (!user.favorite_locations || user.favorite_locations.length === 0) {
        content.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
            <p class="text-white-50">Người dùng chưa có địa điểm yêu thích nào</p>
          </div>
        `;
        return;
      }

      let html = '<div class="row g-3">';
      user.favorite_locations.forEach(location => {
        html += `
          <div class="col-md-6">
            <div class="admin-card p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="text-white mb-1">
                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                    ${location.name}
                  </h6>
                  <p class="text-white-50 small mb-0">
                    ${location.coordinates[0]}, ${location.coordinates[1]}
                  </p>
                </div>
                <span class="badge ${location.alerts_enabled ? 'bg-success' : 'bg-secondary'}">
                  ${location.alerts_enabled ? 'Bật cảnh báo' : 'Tắt cảnh báo'}
                </span>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      content.innerHTML = html;
    }

    function loadUserAlerts(user) {
      const content = document.getElementById('alertsContent');

      // Get user subscriptions from favorite locations
      const subscriptions = user.favorite_locations || [];

      let html = '';

      // User info header
      html += `<div class="mb-3">
        <h6 class="mb-0"><i class="fas fa-user me-2"></i><strong>Thông tin người dùng:</strong> ${user.name}</h6>
      </div>`;

      // Show per-subscription list with admin toggles
      if (!subscriptions || subscriptions.length === 0) {
        html += `
          <div class="text-center py-4">
            <i class="fas fa-map-pin fa-3x text-muted mb-3"></i>
            <p class="text-muted">Người dùng chưa đăng ký trạm nào</p>
          </div>`;
      } else {
        subscriptions.forEach((location, index) => {
          // Mock data for each subscription
          const registrationDate = new Date(2025, 8, 22 + index).toLocaleDateString('vi-VN');
          const currentAQI = Math.floor(Math.random() * 200) + 50; // Mock AQI 50-250
          const threshold = user.alert_settings?.[0]?.threshold || 100;
          const alertEnabled = index % 2 === 0; // Mock some enabled, some disabled

          html += `
            <div class="card mb-3 subscription-card">
              <div class="card-body py-3">
                <div class="d-flex align-items-center">
                  <div class="subscription-info flex-grow-1">
                    <h6 class="mb-1">${location}</h6>
                    <div class="subscription-meta small text-muted">
                      <span class="me-3"><strong>Đăng ký:</strong> ${registrationDate}</span>
                      <span class="me-3"><strong>AQI:</strong> <span class="badge ${currentAQI > 100 ? 'bg-danger' : currentAQI > 50 ? 'bg-warning text-dark' : 'bg-success'}">${currentAQI}</span></span>
                      <span><strong>Ngưỡng:</strong> <span class="text-nowrap">${threshold}</span></span>
                    </div>
                  </div>

                  <div class="subscription-control text-end ms-3">
                    <div class="form-check form-switch">
       <input class="form-check-input alert-toggle-inline-mock" type="checkbox" 
         ${alertEnabled ? 'checked' : ''} 
         data-user-id="${user.id}" 
         data-station="${location ? location.replace(/"/g, '&quot;') : ''}"
         data-station-id=""
         data-sub-id=""
         id="alertToggleInline${index}">
                      <label class="form-check-label" for="alertToggleInline${index}">
                        <i class="fas ${alertEnabled ? 'fa-bell' : 'fa-bell-slash'} me-1"></i>
                        <span class="ms-1 alert-label-text">${alertEnabled ? 'Bật' : 'Tắt'}</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        // Add event listeners for alert toggles (inline version)
        setTimeout(() => {
          document.querySelectorAll('.alert-toggle-inline-mock').forEach(toggle => {
            toggle.addEventListener('change', function(event) {
              const toggle = event.target;
              const userId = toggle.dataset.userId;
              const stationName = toggle.dataset.station;
              const isEnabled = toggle.checked;
              
              // Update the label and icon immediately for better UX
              const label = toggle.nextElementSibling;
              const icon = label.querySelector('i');
              icon.className = `fas ${isEnabled ? 'fa-bell' : 'fa-bell-slash'} me-1`;
              const textSpan = label.querySelector('.alert-label-text');
              if (textSpan) {
                textSpan.textContent = isEnabled ? 'Bật' : 'Tắt';
              } else {
                label.innerHTML = `<i class="fas ${isEnabled ? 'fa-bell' : 'fa-bell-slash'} me-1"></i><span class="ms-1 alert-label-text">${isEnabled ? 'Bật' : 'Tắt'}</span>`;
              }

              // Show toast notification (mock behavior only)
              showToast(`Đã ${isEnabled ? 'bật' : 'tắt'} cảnh báo cho trạm ${stationName} (Mock)`, 'info');
            });
          });
        }, 100);
      }

      content.innerHTML = html;
    }

    // Bulk actions
    function bulkActivate() {
      alert('Chức năng Kích hoạt hàng loạt đã được thay thế. Vui lòng dùng "Chuyển trạng thái" để cập nhật trạng thái người dùng.');
    }

    function bulkDeactivate() {
      alert('Chức năng Vô hiệu hóa hàng loạt đã được thay thế. Vui lòng dùng "Chuyển trạng thái" để cập nhật trạng thái người dùng.');
    }

    function bulkDelete() {
      // Bulk delete disabled in UI
      alert('Xóa hàng loạt đã bị vô hiệu hóa trong giao diện. Vui lòng sử dụng API hoặc công cụ quản trị để xóa.');
    }

    function bulkExport() {
      showToast('Đang xuất dữ liệu ' + selectedUsers.size + ' người dùng...', 'info');
    }

    function toggleUserStatus(userId) {
      const user = mockUsers.find(u => u.id === userId);
      if (user) {
        user.status = user.status === 'active' ? 'inactive' : 'active';
        renderUserTable();
        showToast(`Đã ${user.status === 'active' ? 'kích hoạt' : 'vô hiệu hóa'} người dùng ${user.name}`, 
                  user.status === 'active' ? 'success' : 'warning');
      }
    }

    function editUser() {
      // Get current user ID from modal title or hidden input
      const userDetailModal = document.getElementById('userDetailModal');
      const currentUserId = userDetailModal.dataset.userId;
      const user = mockUsers.find(u => u.id == currentUserId);
      
      if (!user) {
        showToast('Không tìm thấy thông tin người dùng!', 'error');
        return;
      }
      
      // Fill edit form with current user data
      document.getElementById('editUserName').value = user.name;
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserRole').value = user.role;
      document.getElementById('editUserStatus').value = user.status;
      document.getElementById('editUserCreated').value = user.created_at;
      document.getElementById('editUserLastLogin').value = user.last_login;
      
      // Store user ID in edit modal
      const editModal = document.getElementById('editUserModal');
      editModal.dataset.userId = currentUserId;
      
      // Close detail modal and show edit modal
      const detailModalInstance = bootstrap.Modal.getInstance(userDetailModal);
      detailModalInstance.hide();
      
      setTimeout(() => {
        const editModalInstance = new bootstrap.Modal(editModal);
        editModalInstance.show();
      }, 300);
    }

    // Save user changes function
    function saveUserChanges() {
      const editModal = document.getElementById('editUserModal');
      const userId = editModal.dataset.userId;
      
      // Get form values
      const name = document.getElementById('editUserName').value.trim();
      const email = document.getElementById('editUserEmail').value.trim();
      const role = document.getElementById('editUserRole').value;
      const status = document.getElementById('editUserStatus').value;
      
      // Basic validation
      if (!name || !email) {
        showToast('Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
        return;
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Email không hợp lệ!', 'error');
        return;
      }
      
      // Check if email already exists (except for current user)
      const existingUser = mockUsers.find(u => u.email === email && u.id != userId);
      if (existingUser) {
        showToast('Email này đã được sử dụng bởi người dùng khác!', 'error');
        return;
      }
      
      // Update user in mockUsers array
      const userIndex = mockUsers.findIndex(u => u.id == userId);
      if (userIndex !== -1) {
        mockUsers[userIndex] = {
          ...mockUsers[userIndex],
          name: name,
          email: email,
          role: role,
          status: status
        };
        
        // Close modal
        const editModalInstance = bootstrap.Modal.getInstance(editModal);
        editModalInstance.hide();
        
        // Refresh table
        loadUsers();
        
        showToast('Cập nhật thông tin người dùng thành công!', 'success');
      } else {
        showToast('Có lỗi xảy ra khi cập nhật thông tin!', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastBody = document.getElementById('toastBody');
      
      // Update icon based on type
      const icon = {
        'success': 'fas fa-check-circle text-success',
        'warning': 'fas fa-exclamation-triangle text-warning',
        'info': 'fas fa-info-circle text-info',
        'error': 'fas fa-times-circle text-danger'
      }[type] || 'fas fa-info-circle text-info';
      
      document.querySelector('#toast .toast-header i').className = icon + ' me-2';
      toastBody.textContent = message;
      
      // Show the toast
      toast.style.display = 'block';
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      // Hide toast after it's been shown and then hidden
      toast.addEventListener('hidden.bs.toast', function() {
        this.style.display = 'none';
      });
    }
    
    } // End of disabled inline script block

    // Simple authentication functions for API testing
    function showLoginForm() {
      const email = prompt('Nhập email admin:');
      const password = prompt('Nhập mật khẩu:');
      
      if (email && password) {
        login(email, password);
      }
    }

    async function login(email, password) {
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        if (response.ok) {
          const data = await response.json();
          
          // Store token
          localStorage.setItem('access_token', data.access_token);
          
          // Update UI
          updateAuthStatus(true, email);
          showToast('Đăng nhập thành công!', 'success');
          
          // Reload user data
          if (window.__adminUserManagement) {
            window.__adminUserManagement.loadUsers();
          }
        } else {
          const error = await response.json();
          showToast('Lỗi đăng nhập: ' + (error.message || 'Thông tin không hợp lệ'), 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        showToast('Lỗi kết nối: ' + error.message, 'error');
      }
    }

    function logout() {
      localStorage.removeItem('access_token');
      sessionStorage.removeItem('access_token');
      updateAuthStatus(false);
      showToast('Đã đăng xuất', 'info');
      
      // Reload with mock data
      if (window.__adminUserManagement) {
        window.__adminUserManagement.loadMockData();
      }
    }

    function updateAuthStatus(isLoggedIn, email = '') {
      const authStatus = document.getElementById('authStatus');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      // Defensive: guard against missing elements (some admin pages may not include all controls)
      try {
        if (isLoggedIn) {
          if (authStatus) authStatus.textContent = `Đã đăng nhập: ${email}`;
          if (loginBtn) loginBtn.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'inline-block';
        } else {
          if (authStatus) authStatus.textContent = 'Chưa đăng nhập';
          if (loginBtn) loginBtn.style.display = 'inline-block';
          if (logoutBtn) logoutBtn.style.display = 'none';
        }
      } catch (e) {
        // If anything unexpected happens (for example, a non-HTMLElement), just log and continue
        console.warn('updateAuthStatus: failed to update UI elements', e);
      }
    }

    // Check auth status on page load
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('access_token');
      if (token) {
        try {
          updateAuthStatus(true, 'Admin');
        } catch (e) {
          console.warn('Could not update auth status on DOMContentLoaded', e);
        }
      }
    });
  </script>

  <!-- Defensive wiring: delegated listeners and fallback export -->
  <script>
    (function() {
      console.log('[user_management.html] defensive wiring loaded');

      // Ensure selectedUsers exists (inline script defines it) otherwise create one
      if (typeof selectedUsers === 'undefined') {
        window.selectedUsers = new Set();
      }

      // Delegated listener to keep selection in sync when any checkbox changes
      function updateSelectionFromCheckboxes() {
        // Rebuild selectedUsers from current checkboxes to avoid drift
        const checkboxes = document.querySelectorAll('.user-checkbox');
        selectedUsers.clear();
        checkboxes.forEach(cb => {
          const id = parseInt(cb.value, 10);
          if (!Number.isNaN(id) && cb.checked) selectedUsers.add(id);
        });

        // Update UI visibility and counts
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        const bulkBtns = document.querySelectorAll('.bulk-action-btn');

        if (selectedUsers.size > 0) {
          bulkActions && bulkActions.classList.add('show');
          selectedCount && (selectedCount.textContent = selectedUsers.size);
        } else {
          bulkActions && bulkActions.classList.remove('show');
          selectedCount && (selectedCount.textContent = 0);
        }

        // Enable/disable bulk buttons
        bulkBtns.forEach(b => b.disabled = selectedUsers.size === 0);
      }

      document.addEventListener('change', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('user-checkbox')) {
          // If inline helper exists, prefer it (keeps existing behavior)
          if (typeof toggleUserSelection === 'function') {
            try { toggleUserSelection(parseInt(e.target.value, 10)); } catch (err) { console.warn('toggleUserSelection error', err); }
            // toggleUserSelection will call updateBulkActions in inline script, but ensure sync after slight delay
            setTimeout(updateSelectionFromCheckboxes, 30);
            return;
          }

          // Otherwise rebuild selection from checkboxes
          updateSelectionFromCheckboxes();
        }
      });

      // Delegated listener for Select All (header checkbox)
      document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'selectAllUsers') {
          const checked = e.target.checked;
          const checkboxes = document.querySelectorAll('.user-checkbox');
          checkboxes.forEach(cb => { cb.checked = checked; });
          // Rebuild selection and update UI
          updateSelectionFromCheckboxes();
        }
      });

      // Fallback CSV export if function not defined
      if (typeof bulkExport === 'undefined') {
        window.bulkExport = function() {
          try {
            const exportUsers = Array.from(selectedUsers).length > 0
              ? mockUsers.filter(u => selectedUsers.has(u.id))
              : mockUsers.slice();

            if (!exportUsers || exportUsers.length === 0) {
              showToast && showToast('Không có người dùng để xuất', 'warning');
              return;
            }

            const headers = ['ID','Tên','Email','Vai trò','Trạng thái','Ngày tham gia','Địa điểm yêu thích'];
            const rows = exportUsers.map(u => [u.id, u.name, u.email, u.role, u.status, new Date(u.created_at).toLocaleDateString('vi-VN'), (u.favorite_locations||[]).map(l=>l.name).join('; ')]);
            const csvContent = [headers, ...rows].map(r => r.map(f => '"' + String(f).replace(/"/g,'""') + '"').join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `users_export_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            showToast && showToast('Đã xuất file CSV', 'success');
          } catch (err) {
            console.error('bulkExport fallback error', err);
            showToast && showToast('Lỗi khi xuất CSV', 'error');
          }
        };
      }
    })();
  </script>
</body>
</html>