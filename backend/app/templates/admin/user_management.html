<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Admin Dashboard - User Management</title>

  <!-- Fonts and icons (same as dashboard) -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files (same as dashboard) -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/theme-switcher.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/admin_dashboard.css') }}" rel="stylesheet" />
</head>

<body class="">
  <div class="admin-wrapper">
    <!-- Navbar (similar to dashboard) -->
    <nav class="navbar navbar-expand-lg navbar-absolute" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div class="container-fluid">
        <div class="navbar-wrapper">
          <a class="navbar-brand text-white" href="/">
            <i class="fas fa-tachometer-alt me-2"></i>
            Air Quality Monitor
          </a>
        </div>
        <div class="navbar-nav ms-auto">
          <!-- Theme Toggle Switch -->
          <div class="nav-item me-3">
            <div class="form-check form-switch d-flex align-items-center">
              <input class="form-check-input" type="checkbox" id="themeToggle" checked>
              <label class="form-check-label text-white ms-2" for="themeToggle">
                <i class="fas fa-moon" id="themeIcon"></i>
              </label>
            </div>
          </div>
          
          <a class="nav-link text-white" href="/">
            <i class="fas fa-home me-1"></i>Dashboard
          </a>
          <a class="nav-link text-white" href="/reports">
            <i class="fas fa-chart-bar me-1"></i>Reports  
          </a>
          <a class="nav-link text-white" href="/admin">
            <i class="fas fa-users me-1"></i>Admin
          </a>
          <a class="nav-link text-white" href="/login">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-content">
      <div class="container-fluid py-4">
        <!-- Header -->
        <div class="admin-header">
          <div class="row">
            <div class="col-12">
              <h1><i class="fas fa-users me-2"></i>User Management</h1>
              <p class="mb-0">Quản lý người dùng và hệ thống</p>
            </div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-header">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="searchUser" class="form-label text-white-50">Tìm kiếm người dùng</label>
              <input type="text" class="form-control" id="searchUser" placeholder="Tên, email hoặc ID...">
            </div>
            <div class="col-md-2">
              <label for="filterStatus" class="form-label text-white-50">Trạng thái</label>
              <select class="form-select" id="filterStatus">
                <option value="">Tất cả</option>
                <option value="active">Hoạt động</option>
                <option value="inactive">Không hoạt động</option>
                <option value="suspended">Tạm khóa</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="filterRole" class="form-label text-white-50">Vai trò</label>
              <select class="form-select" id="filterRole">
                <option value="">Tất cả</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="sortBy" class="form-label text-white-50">Sắp xếp</label>
              <select class="form-select" id="sortBy">
                <option value="created_desc">Mới nhất</option>
                <option value="created_asc">Cũ nhất</option>
                <option value="name_asc">Tên A-Z</option>
                <option value="name_desc">Tên Z-A</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="fas fa-search me-1"></i>Tìm kiếm
              </button>
            </div>
          </div>
        </div>

        <!-- User Table -->
        <div class="admin-card">
          <div class="card-body p-0">
            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span id="selectedCount">0</span> người dùng được chọn
                </div>
                <div class="btn-group">
                  <button class="btn btn-outline-light btn-sm bulk-action-btn" onclick="bulkActivate()">
                    <i class="fas fa-check me-1"></i>Kích hoạt
                  </button>
                  <button class="btn btn-outline-light btn-sm bulk-action-btn" onclick="bulkDeactivate()">
                    <i class="fas fa-times me-1"></i>Vô hiệu hóa
                  </button>
                  <button class="btn btn-outline-danger btn-sm bulk-action-btn" onclick="bulkDelete()">
                    <i class="fas fa-trash me-1"></i>Xóa
                  </button>
                  <button class="btn btn-outline-light btn-sm bulk-action-btn" onclick="bulkExport()">
                    <i class="fas fa-download me-1"></i>Xuất dữ liệu
                  </button>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-dark table-hover mb-0">
                <thead>
                  <tr>
                    <th scope="col" width="5%">
                      <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th scope="col" width="10%">Avatar</th>
                    <th scope="col" width="20%">Thông tin</th>
                    <th scope="col" width="15%">Trạng thái</th>
                    <th scope="col" width="15%">Vai trò</th>
                    <th scope="col" width="15%">Ngày tham gia</th>
                    <th scope="col" width="10%">Hoạt động</th>
                    <th scope="col" width="10%">Thao tác</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <!-- Mock data will be inserted here by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center p-3">
              <div class="showing-info text-white-50">
                Hiển thị <span id="showingStart">1</span> - <span id="showingEnd">10</span> trong tổng số <span id="totalUsers">0</span> người dùng
              </div>
              <nav aria-label="User pagination">
                <ul class="pagination mb-0" id="paginationNav">
                  <!-- Pagination will be generated by JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- User Detail Modal -->
        <div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="userDetailModalLabel">
                  <i class="fas fa-user me-2"></i>Chi tiết người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="userDetailTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab">
                      <i class="fas fa-user me-1"></i>Thông tin cơ bản
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations" type="button" role="tab">
                      <i class="fas fa-map-marker-alt me-1"></i>Địa điểm yêu thích
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                      <i class="fas fa-bell me-1"></i>Cảnh báo
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                      <i class="fas fa-chart-line me-1"></i>Hoạt động
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3" id="userDetailTabContent">
                  <!-- Basic Info Tab -->
                  <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
                    <div id="basicInfoContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- Locations Tab -->
                  <div class="tab-pane fade" id="locations" role="tabpanel">
                    <div id="locationsContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- Alerts Tab -->
                  <div class="tab-pane fade" id="alerts" role="tabpanel">
                    <div id="alertsContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>

                  <!-- Activity Tab -->
                  <div class="tab-pane fade" id="activity" role="tabpanel">
                    <div id="activityContent">
                      <!-- Content loaded by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="editUser()" id="editUserBtn">
                  <i class="fas fa-edit me-1"></i>Chỉnh sửa
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                  <i class="fas fa-edit me-2"></i>Chỉnh sửa người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editUserForm">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="editUserName" class="form-label">Họ tên</label>
                      <input type="text" class="form-control" id="editUserName" required>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserEmail" class="form-label">Email</label>
                      <input type="email" class="form-control" id="editUserEmail" required>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserRole" class="form-label">Vai trò</label>
                      <select class="form-select" id="editUserRole" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="editUserStatus" class="form-label">Trạng thái</label>
                      <select class="form-select" id="editUserStatus" required>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Không hoạt động</option>
                        <option value="suspended">Tạm khóa</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <div class="row">
                        <div class="col-md-6">
                          <label class="form-label">Ngày tham gia</label>
                          <input type="text" class="form-control" id="editUserCreated" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Đăng nhập cuối</label>
                          <input type="text" class="form-control" id="editUserLastLogin" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="saveUserChanges()">
                  <i class="fas fa-save me-1"></i>Lưu thay đổi
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Spinner removed to avoid accidental overlay blocking interaction.
             If needed, re-add and use JS to toggle a `.show` class on the element. -->

        <!-- Toast Container -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
            <div class="toast-header">
              <i class="fas fa-info-circle text-primary me-2"></i>
              <strong class="me-auto">Thông báo</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
              <!-- Toast message will be set by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Scripts -->
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script>
    console.log('jQuery loaded (local):', typeof window.jQuery !== 'undefined');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load black-dashboard after jQuery is available to avoid `$ is not defined` errors -->
  <script>
    (function loadBlackDashboard(retries) {
      retries = retries || 0;
      if (typeof window.jQuery !== 'undefined' || retries > 10) {
        var script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}";
        script.onload = function() { console.log('black-dashboard.min.js loaded'); };
        script.onerror = function() {
          console.error('Failed to load black-dashboard.min.js');
        };
        document.body.appendChild(script);
      } else {
        // Retry after a short delay
        setTimeout(function() { loadBlackDashboard(retries + 1); }, 100);
      }
    })();
  </script>

  <!-- Admin class-based script (optional) -->
  <script src="{{ url_for('static', filename='js/assets/admin_user_management.js') }}"></script>

  <script>
    // Mock Data - Beautiful sample users
    const mockUsers = [
      {
        id: 1,
        name: "Nguyễn Văn Admin",
        email: "admin@aqimonitor.vn",
        avatar: null,
        status: "active",
        role: "admin",
        created_at: "2024-01-15T08:30:00Z",
        last_login: "2025-09-22T10:15:00Z",
        favorite_locations: [
          { name: "Hà Nội", coordinates: [21.0285, 105.8542], alerts_enabled: true },
          { name: "TP.HCM", coordinates: [10.8231, 106.6297], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "AQI", threshold: 100, enabled: true },
          { type: "PM2.5", threshold: 50, enabled: true }
        ],
        login_count: 245,
        reports_generated: 12
      },
      {
        id: 2,
        name: "Trần Thị Minh",
        email: "minh.tran@email.com",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-02-10T14:20:00Z",
        last_login: "2025-09-21T16:45:00Z",
        favorite_locations: [
          { name: "Đà Nẵng", coordinates: [16.0544, 108.2022], alerts_enabled: true },
          { name: "Hội An", coordinates: [15.8801, 108.338], alerts_enabled: false }
        ],
        alert_settings: [
          { type: "AQI", threshold: 150, enabled: true }
        ],
        login_count: 89,
        reports_generated: 3
      },
      {
        id: 3,
        name: "Lê Hoàng Nam",
        email: "nam.le@company.vn",
        avatar: null,
        status: "inactive",
        role: "user",
        created_at: "2024-03-05T09:15:00Z",
        last_login: "2025-09-15T08:30:00Z",
        favorite_locations: [
          { name: "Cần Thơ", coordinates: [10.0452, 105.7469], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "PM2.5", threshold: 75, enabled: true },
          { type: "PM10", threshold: 100, enabled: false }
        ],
        login_count: 156,
        reports_generated: 7
      },
      {
        id: 4,
        name: "Phạm Thị Hoa",
        email: "hoa.pham@gmail.com",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-04-12T11:45:00Z",
        last_login: "2025-09-22T09:20:00Z",
        favorite_locations: [
          { name: "Huế", coordinates: [16.4637, 107.5909], alerts_enabled: true },
          { name: "Quảng Ninh", coordinates: [20.9588, 107.0428], alerts_enabled: true },
          { name: "Hà Long", coordinates: [20.9101, 107.1839], alerts_enabled: false }
        ],
        alert_settings: [
          { type: "AQI", threshold: 120, enabled: true }
        ],
        login_count: 67,
        reports_generated: 5
      },
      {
        id: 5,
        name: "Võ Minh Quang",
        email: "quang.vo@tech.vn",
        avatar: null,
        status: "suspended",
        role: "user",
        created_at: "2024-05-20T16:30:00Z",
        last_login: "2025-09-10T14:15:00Z",
        favorite_locations: [
          { name: "Nha Trang", coordinates: [12.2388, 109.1967], alerts_enabled: false }
        ],
        alert_settings: [],
        login_count: 23,
        reports_generated: 1
      },
      {
        id: 6,
        name: "Đỗ Thị Lan",
        email: "lan.do@university.edu.vn",
        avatar: null,
        status: "active",
        role: "user",
        created_at: "2024-06-18T13:25:00Z",
        last_login: "2025-09-21T18:30:00Z",
        favorite_locations: [
          { name: "Vũng Tàu", coordinates: [10.4113, 107.1441], alerts_enabled: true }
        ],
        alert_settings: [
          { type: "PM2.5", threshold: 60, enabled: true }
        ],
        login_count: 112,
        reports_generated: 8
      }
    ];

    let currentPage = 1;
    let itemsPerPage = 5;
    let filteredUsers = [...mockUsers];
    let selectedUsers = new Set();

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[user_management.html inline script] DOMContentLoaded - initializing inline logic');
      renderUserTable();
      setupEventListeners();
      initializeTheme();
    });

    function initializeTheme() {
      // Check if user has a saved theme preference
      const savedTheme = localStorage.getItem('adminTheme');
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      if (savedTheme === 'light') {
        document.querySelector('.admin-wrapper').classList.add('light-mode');
        themeToggle.checked = false;
        themeIcon.className = 'fas fa-sun';
      } else {
        themeToggle.checked = true;
        themeIcon.className = 'fas fa-moon';
      }

      // Add event listener for theme toggle
      themeToggle.addEventListener('change', toggleTheme);
    }

    function toggleTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const adminWrapper = document.querySelector('.admin-wrapper');

      if (themeToggle.checked) {
        // Dark mode
        adminWrapper.classList.remove('light-mode');
        themeIcon.className = 'fas fa-moon';
        localStorage.setItem('adminTheme', 'dark');
        showToast('Đã chuyển sang chế độ tối', 'info');
      } else {
        // Light mode
        adminWrapper.classList.add('light-mode');
        themeIcon.className = 'fas fa-sun';
        localStorage.setItem('adminTheme', 'light');
        showToast('Đã chuyển sang chế độ sáng', 'info');
      }
    }

    function setupEventListeners() {
      // Search input
      document.getElementById('searchUser').addEventListener('input', debounce(applyFilters, 300));
      
      // Filter dropdowns
      document.getElementById('filterStatus').addEventListener('change', applyFilters);
      document.getElementById('filterRole').addEventListener('change', applyFilters);
      document.getElementById('sortBy').addEventListener('change', applyFilters);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function applyFilters() {
      const searchTerm = document.getElementById('searchUser').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      const roleFilter = document.getElementById('filterRole').value;
      const sortBy = document.getElementById('sortBy').value;

      // Filter users
      filteredUsers = mockUsers.filter(user => {
        const matchesSearch = !searchTerm || 
          user.name.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm) ||
          user.id.toString().includes(searchTerm);
        
        const matchesStatus = !statusFilter || user.status === statusFilter;
        const matchesRole = !roleFilter || user.role === roleFilter;

        return matchesSearch && matchesStatus && matchesRole;
      });

      // Sort users
      switch(sortBy) {
        case 'created_asc':
          filteredUsers.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          break;
        case 'created_desc':
          filteredUsers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
        case 'name_asc':
          filteredUsers.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'name_desc':
          filteredUsers.sort((a, b) => b.name.localeCompare(a.name));
          break;
      }

      currentPage = 1;
      renderUserTable();
    }

    // Load users function (alias for renderUserTable)
    function loadUsers() {
      renderUserTable();
    }

    function renderUserTable() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageUsers = filteredUsers.slice(startIndex, endIndex);

      const tableBody = document.getElementById('userTableBody');
      tableBody.innerHTML = '';

      pageUsers.forEach(user => {
        const row = createUserRow(user);
        tableBody.appendChild(row);
      });

      updatePagination();
      updateShowingInfo();
    }

    function createUserRow(user) {
      const row = document.createElement('tr');
      
      // Status badge
      const statusClass = {
        'active': 'bg-success',
        'inactive': 'bg-warning text-dark',
        'suspended': 'bg-danger'
      }[user.status] || 'bg-secondary';

      const statusText = {
        'active': 'Hoạt động',
        'inactive': 'Không hoạt động',
        'suspended': 'Tạm khóa'
      }[user.status] || 'Không xác định';

      // Role badge
      const roleClass = {
        'admin': 'bg-primary',
        'user': 'bg-info text-dark'
      }[user.role] || 'bg-secondary';

      const roleText = {
        'admin': 'Admin',
        'user': 'User'
      }[user.role] || 'Unknown';

      // Avatar initials
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      // Format dates
      const createdDate = new Date(user.created_at).toLocaleDateString('vi-VN');
      const lastLoginDate = new Date(user.last_login).toLocaleDateString('vi-VN');

      row.innerHTML = `
        <td>
          <input class="form-check-input user-checkbox" type="checkbox" value="${user.id}" onchange="toggleUserSelection(${user.id})">
        </td>
        <td>
          <div class="avatar-title">${initials}</div>
        </td>
        <td>
          <div>
            <strong class="text-white">${user.name}</strong>
            <br>
            <small class="text-white-50">${user.email}</small>
          </div>
        </td>
        <td>
          <span class="badge ${statusClass}">${statusText}</span>
          <br>
          <small class="text-white-50">Đăng nhập: ${lastLoginDate}</small>
        </td>
        <td>
          <span class="badge ${roleClass}">${roleText}</span>
        </td>
        <td>
          <span class="text-white">${createdDate}</span>
          <br>
          <small class="text-white-50">${user.login_count} lần đăng nhập</small>
        </td>
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" ${user.status === 'active' ? 'checked' : ''} onchange="toggleUserStatus(${user.id})">
            <label class="form-check-label text-white-50">Kích hoạt</label>
          </div>
        </td>
        <td>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails(${user.id})" title="Xem chi tiết">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${user.id})" title="Xóa người dùng">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      `;

      return row;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      const paginationNav = document.getElementById('paginationNav');
      
      paginationNav.innerHTML = '';

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Trước</a>`;
      paginationNav.appendChild(prevLi);

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationNav.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Tiếp</a>`;
      paginationNav.appendChild(nextLi);
    }

    function updateShowingInfo() {
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, filteredUsers.length);
      
      document.getElementById('showingStart').textContent = filteredUsers.length > 0 ? startIndex : 0;
      document.getElementById('showingEnd').textContent = endIndex;
      document.getElementById('totalUsers').textContent = filteredUsers.length;
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderUserTable();
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      
      selectedUsers.clear();
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
          selectedUsers.add(parseInt(checkbox.value));
        }
      });
      
      updateBulkActions();
    }

    function toggleUserSelection(userId) {
      if (selectedUsers.has(userId)) {
        selectedUsers.delete(userId);
      } else {
        selectedUsers.add(userId);
      }
      
      // Update select all checkbox
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      selectAll.checked = selectedUsers.size === checkboxes.length;
      selectAll.indeterminate = selectedUsers.size > 0 && selectedUsers.size < checkboxes.length;
      
      updateBulkActions();
    }

    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      if (selectedUsers.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedUsers.size;
      } else {
        bulkActions.classList.remove('show');
      }
    }

    function deleteUser(userId) {
      console.log('deleteUser called with userId:', userId);
      
      const user = mockUsers.find(u => u.id === userId);
      console.log('Found user:', user);
      
      if (!user) {
        showToast('Không tìm thấy người dùng!', 'error');
        return;
      }

      // Confirm delete
      if (confirm(`Bạn có chắc chắn muốn xóa người dùng "${user.name}"?\n\nHành động này không thể hoàn tác!`)) {
        console.log('User confirmed single delete');
        
        // Remove user from mockUsers array
        const index = mockUsers.findIndex(u => u.id === userId);
        console.log('User index in array:', index);
        
        if (index !== -1) {
          mockUsers.splice(index, 1);
          console.log('User removed, new array length:', mockUsers.length);
          
          // Remove from selected users if it was selected
          selectedUsers.delete(userId);
          updateBulkActions();
          
          // Refresh table
          renderUserTable();
          
          showToast(`Đã xóa thành công người dùng "${user.name}"`, 'success');
        } else {
          showToast('Có lỗi xảy ra khi xóa người dùng!', 'error');
        }
      } else {
        console.log('User cancelled single delete');
      }
    }

    function viewUserDetails(userId) {
      const user = mockUsers.find(u => u.id === userId);
      if (!user) return;

      // Store user ID in modal for later use
      const modal = document.getElementById('userDetailModal');
      modal.dataset.userId = userId;

      // Update modal title
      document.getElementById('userDetailModalLabel').innerHTML = 
        `<i class="fas fa-user me-2"></i>Chi tiết: ${user.name}`;

      // Load basic info
      loadBasicInfo(user);
      
      // Load other tabs (will be loaded when clicked)
      loadUserLocations(user);
      loadUserAlerts(user);
      loadUserActivity(user);

      // Show modal
      const modalInstance = new bootstrap.Modal(modal);
      modalInstance.show();
    }

    function loadBasicInfo(user) {
      const content = document.getElementById('basicInfoContent');
      const statusText = {
        'active': 'Hoạt động',
        'inactive': 'Không hoạt động', 
        'suspended': 'Tạm khóa'
      }[user.status];

      const roleText = {
        'admin': 'Quản trị viên',
        'user': 'Người dùng'
      }[user.role];

      content.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">ID:</div>
              <div class="user-info-value">#${user.id}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Họ tên:</div>
              <div class="user-info-value">${user.name}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Email:</div>
              <div class="user-info-value">${user.email}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Trạng thái:</div>
              <div class="user-info-value">${statusText}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Vai trò:</div>
              <div class="user-info-value">${roleText}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Ngày tham gia:</div>
              <div class="user-info-value">${new Date(user.created_at).toLocaleDateString('vi-VN')}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Đăng nhập cuối:</div>
              <div class="user-info-value">${new Date(user.last_login).toLocaleDateString('vi-VN')}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-info-row">
              <div class="user-info-label fw-bold">Số lần đăng nhập:</div>
              <div class="user-info-value">${user.login_count}</div>
            </div>
          </div>
        </div>
      `;
    }

    function loadUserLocations(user) {
      const content = document.getElementById('locationsContent');
      
      if (!user.favorite_locations || user.favorite_locations.length === 0) {
        content.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
            <p class="text-white-50">Người dùng chưa có địa điểm yêu thích nào</p>
          </div>
        `;
        return;
      }

      let html = '<div class="row g-3">';
      user.favorite_locations.forEach(location => {
        html += `
          <div class="col-md-6">
            <div class="admin-card p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="text-white mb-1">
                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                    ${location.name}
                  </h6>
                  <p class="text-white-50 small mb-0">
                    ${location.coordinates[0]}, ${location.coordinates[1]}
                  </p>
                </div>
                <span class="badge ${location.alerts_enabled ? 'bg-success' : 'bg-secondary'}">
                  ${location.alerts_enabled ? 'Bật cảnh báo' : 'Tắt cảnh báo'}
                </span>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      content.innerHTML = html;
    }

    function loadUserAlerts(user) {
      const content = document.getElementById('alertsContent');
      
      if (!user.alert_settings || user.alert_settings.length === 0) {
        content.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
            <p class="text-white-50">Người dùng chưa thiết lập cảnh báo nào</p>
          </div>
        `;
        return;
      }

      let html = '<div class="row g-3">';
      user.alert_settings.forEach(alert => {
        html += `
          <div class="col-md-6">
            <div class="admin-card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-white mb-1">
                    <i class="fas fa-bell text-warning me-2"></i>
                    ${alert.type}
                  </h6>
                  <p class="text-white-50 small mb-0">
                    Ngưỡng: ${alert.threshold}
                  </p>
                </div>
                <span class="badge ${alert.enabled ? 'bg-success' : 'bg-secondary'}">
                  ${alert.enabled ? 'Đã bật' : 'Đã tắt'}
                </span>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      content.innerHTML = html;
    }

    function loadUserActivity(user) {
      const content = document.getElementById('activityContent');
      
      content.innerHTML = `
        <div class="row g-4">
          <div class="col-md-6">
            <div class="admin-card p-3 text-center">
              <i class="fas fa-sign-in-alt fa-2x text-primary mb-2"></i>
              <h4 class="text-white mb-1">${user.login_count}</h4>
              <p class="text-white-50 mb-0">Lần đăng nhập</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="admin-card p-3 text-center">
              <i class="fas fa-chart-bar fa-2x text-success mb-2"></i>
              <h4 class="text-white mb-1">${user.reports_generated}</h4>
              <p class="text-white-50 mb-0">Báo cáo tạo</p>
            </div>
          </div>
          <div class="col-12">
            <div class="admin-card p-3">
              <h6 class="text-white mb-3">
                <i class="fas fa-clock text-info me-2"></i>
                Hoạt động gần đây
              </h6>
              <div class="text-center py-3">
                <i class="fas fa-history fa-2x text-muted mb-2"></i>
                <p class="text-white-50 mb-0">Dữ liệu hoạt động chi tiết sẽ được hiển thị ở đây</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Bulk actions
    function bulkActivate() {
      showToast('Đã kích hoạt ' + selectedUsers.size + ' người dùng', 'success');
      selectedUsers.clear();
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
      renderUserTable();
    }

    function bulkDeactivate() {
      showToast('Đã vô hiệu hóa ' + selectedUsers.size + ' người dùng', 'warning');
      selectedUsers.clear();
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
      renderUserTable();
    }

    function bulkDelete() {
      console.log('bulkDelete called, selectedUsers.size:', selectedUsers.size);
      console.log('selectedUsers contents:', Array.from(selectedUsers));
      
      if (selectedUsers.size === 0) {
        showToast('Vui lòng chọn ít nhất một người dùng để xóa!', 'warning');
        return;
      }

      const selectedCount = selectedUsers.size; // Store count before clearing

      // Confirm delete
      if (confirm(`Bạn có chắc chắn muốn xóa ${selectedCount} người dùng đã chọn?\n\nHành động này không thể hoàn tác!`)) {
        console.log('User confirmed delete');
        
        // Get selected user names for confirmation message
        const selectedUserNames = mockUsers
          .filter(user => selectedUsers.has(user.id))
          .map(user => user.name)
          .slice(0, 3); // Show max 3 names
        
        console.log('Users to delete:', selectedUserNames);
        
        // Remove selected users from mockUsers array
        for (let userId of selectedUsers) {
          const index = mockUsers.findIndex(user => user.id === userId);
          console.log(`Deleting user ID ${userId}, found at index:`, index);
          if (index !== -1) {
            mockUsers.splice(index, 1);
          }
        }
        
        console.log('mockUsers after delete:', mockUsers.length);
        
        // Clear selection
        selectedUsers.clear();
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
        renderUserTable();
        
        // Show success message
        const message = selectedUserNames.length > 0 
          ? `Đã xóa thành công ${selectedUserNames.join(', ')}${selectedUserNames.length === 3 ? '...' : ''}` 
          : `Đã xóa thành công ${selectedCount} người dùng`;
        showToast(message, 'success');
      } else {
        console.log('User cancelled delete');
      }
    }

    function bulkExport() {
      showToast('Đang xuất dữ liệu ' + selectedUsers.size + ' người dùng...', 'info');
    }

    function toggleUserStatus(userId) {
      const user = mockUsers.find(u => u.id === userId);
      if (user) {
        user.status = user.status === 'active' ? 'inactive' : 'active';
        renderUserTable();
        showToast(`Đã ${user.status === 'active' ? 'kích hoạt' : 'vô hiệu hóa'} người dùng ${user.name}`, 
                  user.status === 'active' ? 'success' : 'warning');
      }
    }

    function editUser() {
      // Get current user ID from modal title or hidden input
      const userDetailModal = document.getElementById('userDetailModal');
      const currentUserId = userDetailModal.dataset.userId;
      const user = mockUsers.find(u => u.id == currentUserId);
      
      if (!user) {
        showToast('Không tìm thấy thông tin người dùng!', 'error');
        return;
      }
      
      // Fill edit form with current user data
      document.getElementById('editUserName').value = user.name;
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserRole').value = user.role;
      document.getElementById('editUserStatus').value = user.status;
      document.getElementById('editUserCreated').value = user.created_at;
      document.getElementById('editUserLastLogin').value = user.last_login;
      
      // Store user ID in edit modal
      const editModal = document.getElementById('editUserModal');
      editModal.dataset.userId = currentUserId;
      
      // Close detail modal and show edit modal
      const detailModalInstance = bootstrap.Modal.getInstance(userDetailModal);
      detailModalInstance.hide();
      
      setTimeout(() => {
        const editModalInstance = new bootstrap.Modal(editModal);
        editModalInstance.show();
      }, 300);
    }

    // Save user changes function
    function saveUserChanges() {
      const editModal = document.getElementById('editUserModal');
      const userId = editModal.dataset.userId;
      
      // Get form values
      const name = document.getElementById('editUserName').value.trim();
      const email = document.getElementById('editUserEmail').value.trim();
      const role = document.getElementById('editUserRole').value;
      const status = document.getElementById('editUserStatus').value;
      
      // Basic validation
      if (!name || !email) {
        showToast('Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
        return;
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Email không hợp lệ!', 'error');
        return;
      }
      
      // Check if email already exists (except for current user)
      const existingUser = mockUsers.find(u => u.email === email && u.id != userId);
      if (existingUser) {
        showToast('Email này đã được sử dụng bởi người dùng khác!', 'error');
        return;
      }
      
      // Update user in mockUsers array
      const userIndex = mockUsers.findIndex(u => u.id == userId);
      if (userIndex !== -1) {
        mockUsers[userIndex] = {
          ...mockUsers[userIndex],
          name: name,
          email: email,
          role: role,
          status: status
        };
        
        // Close modal
        const editModalInstance = bootstrap.Modal.getInstance(editModal);
        editModalInstance.hide();
        
        // Refresh table
        loadUsers();
        
        showToast('Cập nhật thông tin người dùng thành công!', 'success');
      } else {
        showToast('Có lỗi xảy ra khi cập nhật thông tin!', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastBody = document.getElementById('toastBody');
      
      // Update icon based on type
      const icon = {
        'success': 'fas fa-check-circle text-success',
        'warning': 'fas fa-exclamation-triangle text-warning',
        'info': 'fas fa-info-circle text-info',
        'error': 'fas fa-times-circle text-danger'
      }[type] || 'fas fa-info-circle text-info';
      
      document.querySelector('#toast .toast-header i').className = icon + ' me-2';
      toastBody.textContent = message;
      
      // Show the toast
      toast.style.display = 'block';
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      // Hide toast after it's been shown and then hidden
      toast.addEventListener('hidden.bs.toast', function() {
        this.style.display = 'none';
      });
    }
  </script>

  <!-- Defensive wiring: delegated listeners and fallback export -->
  <script>
    (function() {
      console.log('[user_management.html] defensive wiring loaded');

      // Ensure selectedUsers exists (inline script defines it) otherwise create one
      if (typeof selectedUsers === 'undefined') {
        window.selectedUsers = new Set();
      }

      // Delegated listener to keep selection in sync when any checkbox changes
      function updateSelectionFromCheckboxes() {
        // Rebuild selectedUsers from current checkboxes to avoid drift
        const checkboxes = document.querySelectorAll('.user-checkbox');
        selectedUsers.clear();
        checkboxes.forEach(cb => {
          const id = parseInt(cb.value, 10);
          if (!Number.isNaN(id) && cb.checked) selectedUsers.add(id);
        });

        // Update UI visibility and counts
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        const bulkBtns = document.querySelectorAll('.bulk-action-btn');

        if (selectedUsers.size > 0) {
          bulkActions && bulkActions.classList.add('show');
          selectedCount && (selectedCount.textContent = selectedUsers.size);
        } else {
          bulkActions && bulkActions.classList.remove('show');
          selectedCount && (selectedCount.textContent = 0);
        }

        // Enable/disable bulk buttons
        bulkBtns.forEach(b => b.disabled = selectedUsers.size === 0);
      }

      document.addEventListener('change', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('user-checkbox')) {
          // If inline helper exists, prefer it (keeps existing behavior)
          if (typeof toggleUserSelection === 'function') {
            try { toggleUserSelection(parseInt(e.target.value, 10)); } catch (err) { console.warn('toggleUserSelection error', err); }
            // toggleUserSelection will call updateBulkActions in inline script, but ensure sync after slight delay
            setTimeout(updateSelectionFromCheckboxes, 30);
            return;
          }

          // Otherwise rebuild selection from checkboxes
          updateSelectionFromCheckboxes();
        }
      });

      // Delegated listener for Select All (header checkbox)
      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'selectAll') {
          const checked = e.target.checked;
          const checkboxes = document.querySelectorAll('.user-checkbox');
          checkboxes.forEach(cb => { cb.checked = checked; });
          // Rebuild selection and update UI
          updateSelectionFromCheckboxes();
        }
      });

      // Fallback CSV export if function not defined
      if (typeof bulkExport === 'undefined') {
        window.bulkExport = function() {
          try {
            const exportUsers = Array.from(selectedUsers).length > 0
              ? mockUsers.filter(u => selectedUsers.has(u.id))
              : mockUsers.slice();

            if (!exportUsers || exportUsers.length === 0) {
              showToast && showToast('Không có người dùng để xuất', 'warning');
              return;
            }

            const headers = ['ID','Tên','Email','Vai trò','Trạng thái','Ngày tham gia','Địa điểm yêu thích'];
            const rows = exportUsers.map(u => [u.id, u.name, u.email, u.role, u.status, new Date(u.created_at).toLocaleDateString('vi-VN'), (u.favorite_locations||[]).map(l=>l.name).join('; ')]);
            const csvContent = [headers, ...rows].map(r => r.map(f => '"' + String(f).replace(/"/g,'""') + '"').join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `users_export_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            showToast && showToast('Đã xuất file CSV', 'success');
          } catch (err) {
            console.error('bulkExport fallback error', err);
            showToast && showToast('Lỗi khi xuất CSV', 'error');
          }
        };
      }
    })();
  </script>
</body>
</html>