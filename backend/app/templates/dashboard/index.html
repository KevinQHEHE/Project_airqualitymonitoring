<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  {# N·∫øu c√≥ img th√¨ t·∫°o th∆∞ m·ª•c img trong js/assets/img/ v√† copy ·∫£nh v√†o, c√≤n kh√¥ng th√¨ x√≥a 2 d√≤ng d∆∞·ªõi #}
  {# <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='js/assets/img/apple-icon.png') }}" /> #}
  {# <link rel="icon" type="image/png" href="{{ url_for('static', filename='js/assets/img/favicon.png') }}" /> #}
  <title>Air Quality Monitor Dashboard</title>

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/theme-switcher.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/favorite_buttons.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/subscriptions_page.css') }}" rel="stylesheet" />
  <!-- Demo CSS removed for clean structure -->
  <style>
    /* Minor overrides for static preview */
    body { overflow-x: hidden; }
    .nav .active > a { color: #fff; }
    
    /* Loading overlay */
    #authLoadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1e1e2e;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
    }
    /* NAVBAR ACTIONS: normalize admin button, user pill and theme toggle so they look consistent */
    .navbar-nav .nav-item { display: flex; align-items: center; }

    /* Admin nav item: hidden by default, only shown via JS for admin users */
    #adminNavItem { display: none !important; }
    #adminNavItem.show-admin { display: flex !important; }

    /* User pill */
    .user-pill {
      display: inline-flex;
      align-items: center;
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      transition: background .15s ease, transform .12s ease;
      box-shadow: 0 6px 18px rgba(6,8,20,0.06);
      min-width: 72px;
    }
    .user-pill:hover { background: rgba(255,255,255,0.06); transform: translateY(-1px); }

    .user-initial { width:32px; height:32px; border-radius:50%; background:#667eea; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.95rem; }
    .user-name { color: #fff; font-weight:600; margin-left:8px; font-size:0.95rem; }

    /* Admin button - match height, padding and visual weight */
    #adminNavItem .btn, #adminNavItem a.btn {
      height: 40px;
      padding: 0 14px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(6,8,20,0.06);
      font-weight:600;
      white-space: nowrap; /* prevent label wrapping */
      min-width: 92px;
      font-size: larger;     /* ensure button has enough room for "Qu·∫£n tr·ªã" */
    }
    /* Slightly nudge the icon/text to sit visually centered within the control */
    #adminNavItem .btn i.fas,
    #adminNavItem .btn i.fa {
      display: inline-block;
      transform: translateY(2px);
    }
    #adminNavItem .btn { line-height: 1; }

    /* Theme toggle - square button matching other controls */
    .theme-toggle {
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      margin-left: 12px;
      background: transparent;
      transition: background .12s ease;
    }
    .theme-toggle:hover { background: rgba(255,255,255,0.04); }

    /* Light mode / white-content adjustments: make text dark and add subtle border so pill is visible */
    body.white-content .user-name,
    [data-theme="light"] .user-name { color: #222 !important; }
    body.white-content .user-pill,
    [data-theme="light"] .user-pill {
      background: #ffffff !important;
      border: 1px solid rgba(34,34,34,0.06);
      box-shadow: 0 6px 18px rgba(6,8,20,0.04);
    }
    body.white-content .user-initial,
    [data-theme="light"] .user-initial { background: #5b6bd6; color: #fff; }

    /* Mobile: hide username text and shrink spacing */
    @media (max-width: 767px) {
      .user-name { display: none !important; }
      .theme-toggle { margin-left: 8px; }
      #adminNavItem .btn, #adminNavItem a.btn { padding: 0 10px; min-width: 76px; }
    }
  </style>
</head>
<body class="">
  <!-- Authentication Loading Overlay -->
  <div id="authLoadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Checking authentication...</div>
  </div>

  <!-- Admin shortcut no longer fixed here; navbar contains a nav-item for it (hidden by default) -->

  <!-- Authentication Check Script -->
  <script>
    // Check authentication before showing dashboard
    (async function() {
      const token = localStorage.getItem('access_token');
      
      if (!token) {
        // No token, redirect to login
        window.location.href = '/login';
        return;
      }
      
      try {
        // Verify token with server
        const response = await fetch('/api/auth/verify', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          // Token is invalid, log error detail
          let errorMsg = '';
          try {
            const errData = await response.json();
            errorMsg = errData.error || JSON.stringify(errData);
          } catch (e) {
            errorMsg = response.statusText || 'Unknown error';
          }
          console.error('Token verify failed:', errorMsg);
          alert('Token verify failed: ' + errorMsg);
          // Clear storage and redirect
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          localStorage.removeItem('user_info');
          window.location.href = '/login';
          return;
        }
        
        const userData = await response.json();
        
        // Token is valid, show dashboard
        document.getElementById('authLoadingOverlay').style.display = 'none';
        
        // Update user info display if needed
        updateUserInfo(userData);
        
      } catch (error) {
        console.error('Authentication check failed:', error);
        alert('Authentication check failed: ' + error);
        // On error, redirect to login
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login';
      }
    })();
    
    function updateUserInfo(userData) {
      // Update user display name in sidebar or navbar
      const userInfo = localStorage.getItem('user_info');
      if (userInfo) {
        const user = JSON.parse(userInfo);
        // Update any user display elements
        const userElements = document.querySelectorAll('.user-name');
        userElements.forEach(el => {
          el.textContent = user.username || user.email || 'User';
        });
        
        // Update navbar username
        const navbarUsername = document.getElementById('navbar-username');
        if (navbarUsername) {
          navbarUsername.textContent = user.username || user.email || 'User';
        }
      }
    }

    // Logout functionality
    function logout() {
      const token = localStorage.getItem('access_token');
      if (token) {
        // Call logout API to revoke token
        fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }).then(() => {
          // Clear local storage
          localStorage.removeItem('access_token');
          localStorage.removeItem('user_info');
          
          // Redirect to login
          window.location.href = '/login';
        }).catch(() => {
          // Even if logout API fails, clear local storage and redirect
          localStorage.removeItem('access_token');
          localStorage.removeItem('user_info');
          window.location.href = '/login';
        });
      } else {
        // No token, just redirect to login
        window.location.href = '/login';
      }
    }

    // Add logout event listener when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          logout();
        });
      }
    });

    // Show admin shortcut if token indicates admin role
    function decodeJwtRole(token) {
      try {
        if (!token) return null;
        const parts = token.split('.');
        if (parts.length !== 3) return null;
        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
        return payload && payload.role ? payload.role : null;
      } catch (e) {
        return null;
      }
    }

    // Consolidated DOMContentLoaded: populate user pill, attach logout, and handle admin nav visibility
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Get user info and populate user pill
        const userInfo = localStorage.getItem('user_info');
        let username = 'User';
        if (userInfo) {
          try { username = JSON.parse(userInfo).username || username; } catch(e) { }
        }
        const nameEl = document.getElementById('navbar-username');
        const initialEl = document.getElementById('userInitial');
        if (nameEl) nameEl.textContent = username;
        if (initialEl) initialEl.textContent = (username && username[0]) ? username[0].toUpperCase() : 'U';

        // Attach logout handler
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.addEventListener('click', function(e) { e.preventDefault(); logout(); });

        // Handle admin nav visibility: check token role and explicitly show/hide
        const token = localStorage.getItem('access_token') || '';
        let role = decodeJwtRole(token);
        // Fallback: if decodeJwtRole couldn't find a role, try localStorage user_info
        if (!role) {
          try {
            const ui = localStorage.getItem('user_info');
            if (ui) {
              const parsed = JSON.parse(ui);
              if (parsed && parsed.role) role = parsed.role;
            }
          } catch (e) {
            // ignore parse errors
          }
        }

        const adminNav = document.getElementById('adminNavItem');
        // Debugging: log role so we can see why admin nav might appear
        try { console.debug('[dashboard] decoded role:', role); } catch (e) {}

        if (adminNav) {
          if (role && String(role).toLowerCase() === 'admin') {
            // User is admin: show the admin nav item (use class + explicit style)
            adminNav.classList.add('show-admin');
            try { adminNav.style.setProperty('display','flex','important'); } catch(e){}
          } else {
            // User is not admin or no valid role: explicitly hide the admin nav item using !important
            adminNav.classList.remove('show-admin');
            try { adminNav.style.setProperty('display','none','important'); } catch(e){}
          }
        }
        
      } catch (err) {
        console.error('Dashboard init failed', err);
        // On error, ensure admin nav is hidden for safety
        const adminNav = document.getElementById('adminNavItem');
        if (adminNav) adminNav.classList.remove('show-admin');
      }
    });
  </script>

  <div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar" data-color="blue">
      <div class="sidebar-wrapper">
        <div class="logo">
          <a href="#" class="simple-text logo-mini">AQ</a>
          <a href="#" class="simple-text logo-normal">Air Quality Monitor</a>
        </div>
        <ul class="nav">
          <li class="active" id="dashboard-nav">
            <a href="#" onclick="showDashboard(); return false;">
              <i class="tim-icons icon-chart-pie-36"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li id="subscriptions-nav">
            <a href="#" onclick="showSubscriptions(); return false;">
              <i class="tim-icons icon-heart-2"></i>
              <p>Station Subscriptions</p>
            </a>
          </li>
          <li>
            <a href="#">
              <i class="tim-icons icon-chart-bar-32"></i>
              <p>Prediction</p>
            </a>
          </li>
          <li>
            <a href="#" onclick="handleLogout(); return false;">
              <i class="tim-icons icon-button-power"></i>
              <p>Logout</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main panel -->
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle d-inline">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="#">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse" id="navigation">
            <ul class="navbar-nav ml-auto">
              <!-- Admin button placeholder: shown only for admin users -->
              <li id="adminNavItem" class="nav-item d-flex align-items-center" style="display:none; margin-right:8px;">
                <a id="adminBackBtn" href="/admin" class="btn btn-sm btn-primary">
                  <i class="fas fa-user-shield me-1"></i>Qu·∫£n tr·ªã
                </a>
              </li>
              <li class="nav-item">
                <!-- Re-designed user pill: no external avatar image, responsive name display -->
                <div id="userPill" class="d-flex align-items-center user-pill" style="gap:10px; cursor:pointer;">
                  <div id="userInitial" class="user-initial" aria-hidden="true">U</div>
                  <div id="navbar-username" class="user-name d-none d-md-inline-block">User</div>
                </div>
              </li>
              <li class="input-group d-flex align-items-center mb-0">
                <!-- Theme toggle button (moved to right of user pill) -->
                <button id="themeToggle" class="theme-toggle btn btn-link p-0" type="button" aria-pressed="false" aria-label="Toggle theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun" style="display:none"></i>
                </button>
              </li>
              <li class="separator d-lg-none"></li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Content (Air Quality Search & Dashboard) -->
      <div class="content">
        <!-- Dashboard Content -->
        <div id="dashboard-content">
        <!-- Search Header -->
        <div class="search-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0; margin-bottom: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
          <div class="container">
            <div class="text-center mb-4">
              <h1 style="color: white; margin-bottom: 0.5rem;">Air Quality Monitor</h1>
              <p style="color: rgba(255,255,255,0.8); margin: 0;">Check air quality in your city</p>
            </div>
            
            <div class="search-container" style="max-width: 600px; margin: 0 auto;">
              <div class="search-input-group" style="position: relative; margin-bottom: 1rem;">
                <input type="text" class="search-input" id="citySearch" 
                       placeholder="Enter city, station name, or station ID (e.g., Hanoi, Chi LƒÉng, 13668)..." 
                       autocomplete="off"
                       style="width: 100%; padding: 15px 50px 15px 20px; border: none; border-radius: 50px; font-size: 16px; background: rgba(255,255,255,0.9); box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                <button class="search-btn" onclick="handleCitySearch()"
                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #667eea; border: none; width: 40px; height: 40px; border-radius: 50%; color: white; cursor: pointer; transition: all 0.3s ease;">
                  <i class="tim-icons icon-zoom-split"></i>
                </button>
                
                <div class="search-suggestions" id="searchSuggestions" style="position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-height: 240px; overflow-y: auto; display: none; z-index: 1000;">
                  <!-- Suggestions will be populated here -->
                </div>
              </div>
              
              <div class="quick-search" style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
                <button class="quick-search-btn" onclick="quickSearch('L·∫°ng S∆°n')" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">üèîÔ∏è L·∫°ng S∆°n</button>
                <button class="quick-search-btn" onclick="quickSearch('Hanoi')" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">üèôÔ∏è Hanoi</button>
                <button class="quick-search-btn" onclick="quickSearch('H·ªì Ch√≠ Minh')" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">üåÜ HCMC</button>
                <button class="quick-search-btn" onclick="quickSearch('Da Nang')" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">üèñÔ∏è Da Nang</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Air Quality Result -->
  <div class="air-quality-result" id="airQualityResult" style="border-radius: 14px; padding: 1.25rem; box-shadow: 0 8px 28px rgba(22,24,33,0.08); margin-bottom: 1.75rem; display: none; border: 1px solid rgba(102,126,234,0.06);">
          <div class="row align-items-center">
            <div class="col-lg-7">
              <div class="location-info" style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.25rem; color: #666; gap:8px; flex-wrap:wrap;">
                <span style="display:flex; align-items:center; gap:6px;">
                  <i class="tim-icons icon-pin" style="color: #667eea;"></i>
                  <span id="locationName">Air Quality in Selected City</span>
                </span>
                <span style="display:flex; align-items:center; gap:6px; color:#94a3b8; font-size:0.85rem;">
                  <i class="tim-icons icon-time-alarm" style="color:#94a3b8;"></i>
                  <span id="timestampValue">Updated: ‚Äî</span>
                </span>
                <!-- Subscribe Button -->
                <button id="subscribeBtn" class="subscribe-btn" onclick="toggleStationSubscription()" style="margin-left: auto;">
                  <i class="fas fa-heart heart-icon"></i>
                </button>
              </div>

              <div class="aqi-panel" style="display: flex; gap: 1rem; align-items: center;">
                <div class="aqi-circle" style="width: 150px; height: 150px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; background: linear-gradient(180deg, rgba(102,126,234,0.06), rgba(102,126,234,0.02)); box-shadow: inset 0 -6px 12px rgba(102,126,234,0.03); border: 6px solid rgba(0,0,0,0.03);">
                  <div class="aqi-value aqi-good" id="aqiValue" style="font-size: 2.4rem; font-weight: 800; line-height: 1;">42</div>
                  <div class="aqi-status aqi-good" id="aqiStatus" style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; margin-top: 6px;">Good</div>
                </div>

                <div style="flex:1;">
                  <div class="aqi-description" id="aqiDescription" style="color: #666; font-size: 0.95rem; margin-top: 0.25rem;">
                    Air quality is considered satisfactory, and air pollution poses little or no risk.
                  </div>

                  <div class="pollution-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <div class="pollution-item" style="text-align: center; padding: 1rem; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s ease;">
                      <div class="pollution-value" id="pm25Value" style="font-size: 1.8rem; font-weight: bold;">12.5</div>
                      <div class="pollution-label" style="font-size: 0.9rem; margin-top: 0.5rem;">PM2.5</div>
                    </div>
                    <div class="pollution-item" style="text-align: center; padding: 1rem; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s ease;">
                      <div class="pollution-value" id="pm10Value" style="font-size: 1.8rem; font-weight: bold;">28.2</div>
                      <div class="pollution-label" style="font-size: 0.9rem; margin-top: 0.5rem;">PM10</div>
                    </div>
                    <div class="pollution-item" style="text-align: center; padding: 1rem; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s ease;">
                      <div class="pollution-value" id="o3Value" style="font-size: 1.8rem; font-weight: bold;">15.8</div>
                      <div class="pollution-label" style="font-size: 0.9rem; margin-top: 0.5rem;">O‚ÇÉ</div>
                    </div>
                    <div class="pollution-item" style="text-align: center; padding: 1rem; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s ease;">
                      <div class="pollution-value" id="no2Value" style="font-size: 1.8rem; font-weight: bold;">8.4</div>
                      <div class="pollution-label" style="font-size: 0.9rem; margin-top: 0.5rem;">NO‚ÇÇ</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-5">
              <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="tim-icons icon-chart-pie-36"></i> 12-Hour Trend</h6>
                    <small class="text-muted">Last 12 hours</small>
                  </div>
                  <div class="chart-area" style="height:160px; min-width:420px; width:100%; max-width:600px;">
                    <div id="aqiTrendSummary" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                      <div style="font-weight:700;color:#b58d00;">&nbsp;</div>
                      <div style="font-size:0.9rem;color:#666;">Hourly</div>
                    </div>
                    <canvas id="aqiSearchTrendChart" style="min-width:400px; width:100%; max-width:680px;"></canvas>
                  </div>
                </div>
              </div>

              <div class="card border-0 shadow-sm mt-3">
                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                  <div>
                    <div class="small text-muted">Temperature</div>
                    <div class="h5 mb-0" id="temperature">22¬∞C</div>
                  </div>
                  <div class="text-end">
                    <div class="small text-muted">Humidity</div>
                    <div id="weatherHumidity">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Default Content (shown when no search performed) -->
        <div class="default-content" id="defaultContent" style="text-align: center; color: #666; padding: 3rem 0;">
          <i class="tim-icons icon-world" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem;"></i>
          <h3>Welcome to Air Quality Monitor</h3>
          <p>Search for a city or ZIP code above to view real-time air quality data</p>
        </div>

        <!-- Di chuy·ªÉn forecastCard xu·ªëng ngay sau airQualityResult ƒë·ªÉ lu√¥n hi·ªÉn th·ªã d∆∞·ªõi k·∫øt qu·∫£ AQI -->
        <div class="container-fluid" style="max-width:100vw;">
          <div class="row justify-content-center">
            <div class="col-12">
              <div class="card shadow-sm border-0 mb-4" id="forecastCard" style="display:none; max-width: 100%;">
                <div class="card-header bg-gradient-primary text-white d-flex align-items-center justify-content-between" style="border-radius: 0.5rem 0.5rem 0 0; background: linear-gradient(90deg,#667eea 0%,#764ba2 100%);">
                  <h4 class="mb-0"><i class="tim-icons icon-calendar-60"></i> AQI Forecast</h4>
                  <span class="small">Up to 6 days</span>
                </div>
                <div class="card-body p-4" style="overflow-x:auto; padding-bottom: 1.5rem;">
                  <div id="forecastGrid" style="min-width:900px; width:fit-content; margin:0 auto;">
                    <!-- Forecast cards will be injected here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal for forecast details -->
        <div class="modal fade" id="forecastDetailModal" tabindex="-1" role="dialog" aria-labelledby="forecastDetailLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="forecastDetailLabel">Forecast Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="forecastDetailBody">
                <!-- Details will be injected here -->
              </div>
            </div>
          </div>
        </div>
  <script>
  let aqiChart;
  // Simple client-side caches to reduce API calls during a session
  const cityStationsCache = new Map(); // key: city (lowercase) -> stations array
  const latestCache = new Map(); // key: station_id -> latest measurement
  // Debounce timer for suggestions
  let suggestTimer = null;
  // Current forecast data for theme refresh
  let currentForecastData = null;

  // Fetch forecast data from API
  async function fetchForecastData(stationId, days = 6) {
    try {
      const url = `/api/forecast/weekly?station_id=${encodeURIComponent(stationId)}&days=${days}`;
      const response = await fetch(url, { 
        headers: { 'Accept': 'application/json' } 
      });
      
      if (!response.ok) {
        console.error(`Failed to fetch forecast: HTTP ${response.status}`);
        return null;
      }
      
      const data = await response.json();
      return data.forecast || [];
    } catch (error) {
      console.error('Error fetching forecast data:', error);
      return null;
    }
  }

  function getAQIColor(aqi) {
    if (aqi <= 50) return '#00e676';
    if (aqi <= 100) return '#ffd54f';
    if (aqi <= 150) return '#ff9800';
    if (aqi <= 200) return '#f44336';
    if (aqi <= 300) return '#9c27b0';
    return '#8d6e63';
  }

  function renderForecastGrid(data) {
    // L∆∞u data ƒë·ªÉ c√≥ th·ªÉ refresh khi ƒë·ªïi theme
    currentForecastData = data;
    
    const grid = document.getElementById('forecastGrid');
    if (!grid) {
      console.error('[Forecast] forecastGrid not found in DOM');
      return;
    }
    if (!Array.isArray(data) || !data.length) {
      grid.innerHTML = '<div class="col-12 text-muted">No forecast data available.</div>';
      console.warn('[Forecast] No forecast data to render:', data);
      return;
    }
    
    console.log('[Forecast] renderForecastGrid data:', data);
    
    // Thi·∫øt k·∫ø b·ªë c·ª•c m·ªõi cho 6 ng√†y: 4 tr√™n - 2 d∆∞·ªõi (c√¢n ƒë·ªëi h∆°n)
    grid.className = '';
    let row1, row2;
    const totalDays = Math.min(data.length, 6); // Ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa 6 ng√†y
    const workingData = data.slice(0, totalDays);
    
    if (totalDays <= 4) {
      // 4 ng√†y ho·∫∑c √≠t h∆°n: hi·ªÉn th·ªã tr√™n 1 h√†ng
      row1 = workingData;
      row2 = [];
    } else if (totalDays === 5) {
      // 5 ng√†y: 3 tr√™n - 2 d∆∞·ªõi
      row1 = workingData.slice(0, 3);
      row2 = workingData.slice(3);
    } else {
      // 6 ng√†y: 4 tr√™n - 2 d∆∞·ªõi (ƒë·∫πp v√† c√¢n ƒë·ªëi h∆°n)
      row1 = workingData.slice(0, 4);
      row2 = workingData.slice(4);
    }
    
    function cardHtml(day, idx, color, aqiIcon, uviIcon, pm25Val, pm10Val, uviVal) {
      // Improved dark mode detection
      const bodyHasWhiteContent = document.body.classList.contains('white-content');
      const isDark = !bodyHasWhiteContent;
      
      const bgGradient = isDark 
        ? `linear-gradient(135deg, #23263a 60%, ${color}22 100%)` 
        : `linear-gradient(135deg, #fff 60%, ${color}22 100%)`;
      
      return `<div class="forecast-zigzag-card shadow-sm d-flex flex-column align-items-center justify-content-between p-3" style="border-radius: 1.2rem; background: ${bgGradient} !important; border: none; cursor:pointer; transition:box-shadow .2s,transform .2s; min-width:170px; max-width:200px; min-height:220px; position:relative; margin:0 15px 25px 15px;" onclick="showForecastDetail(${idx})">
        <div class="d-flex flex-column align-items-center mt-4 mb-2">
          <div class="fw-bold mb-1" style="font-size: 1.08rem; margin-bottom:0.35rem;">${day.date}</div>
        </div>
        <div class="w-100 px-1 pb-2">
          <div class="mb-1">
            <div class="d-flex align-items-center justify-content-between"><span class="small text-muted">PM2.5</span> <span class="fw-bold">${pm25Val ?? '--'}</span></div>
            <div class="text-muted text-end" style="font-size:0.7em;">min: ${day.pm25_min ?? '--'} | max: ${day.pm25_max ?? '--'}</div>
          </div>
          <div class="mb-1">
            <div class="d-flex align-items-center justify-content-between"><span class="small text-muted">PM10</span> <span class="fw-bold">${pm10Val ?? '--'}</span></div>
            <div class="text-muted text-end" style="font-size:0.7em;">min: ${day.pm10_min ?? '--'} | max: ${day.pm10_max ?? '--'}</div>
          </div>
          <div class="mb-1">
            <div class="d-flex align-items-center justify-content-between"><span class="small text-muted">UVI</span> <span class="fw-bold">${uviIcon} ${uviVal ?? '--'}</span></div>
            <div class="text-muted text-end" style="font-size:0.7em;">min: ${day.uvi_min ?? '--'} | max: ${day.uvi_max ?? '--'}</div>
          </div>
        </div>
      </div>`;
    }
    
    let html = '';
    
    // Render h√†ng ƒë·∫ßu
    if (row1.length > 0) {
      html += '<div class="d-flex justify-content-center mb-3" style="gap:25px; flex-wrap:wrap;">';
      row1.forEach((day, i) => {
        const pm25Val = Math.round(day.pm25_avg) || '--';
        const pm10Val = Math.round(day.pm10_avg) || '--'; 
        const uviVal = Math.round(day.uvi_avg) || '--';
        const color = day.pm25_avg ? getAQIColor(Math.round(day.pm25_avg)) : '#e2e8f0';
        const aqiIcon = '<i class="fas fa-wind" style="font-size:2.3rem;"></i>';
        const uviIcon = '<i class="fas fa-sun" style="color:#fbbf24;"></i>';
        html += cardHtml(day, i, color, aqiIcon, uviIcon, pm25Val, pm10Val, uviVal);
      });
      html += '</div>';
    }
    
    // Render h√†ng th·ª© hai (n·∫øu c√≥) - canh gi·ªØa cho ƒë·∫πp
    if (row2.length > 0) {
      html += '<div class="d-flex justify-content-center" style="gap:25px; flex-wrap:wrap;">';
      row2.forEach((day, i) => {
        const idx = row1.length + i;
        const pm25Val = Math.round(day.pm25_avg) || '--';
        const pm10Val = Math.round(day.pm10_avg) || '--';
        const uviVal = Math.round(day.uvi_avg) || '--';
        const color = day.pm25_avg ? getAQIColor(Math.round(day.pm25_avg)) : '#e2e8f0';
        const aqiIcon = '<i class="fas fa-wind" style="font-size:2.3rem;"></i>';
        const uviIcon = '<i class="fas fa-sun" style="color:#fbbf24;"></i>';
        html += cardHtml(day, idx, color, aqiIcon, uviIcon, pm25Val, pm10Val, uviVal);
      });
      html += '</div>';
    }
    
    grid.innerHTML = html;
    
    // Th√™m CSS hover ƒë·∫πp h∆°n
    const styleId = 'forecast-card-style';
    if (!document.getElementById(styleId)) {
      const style = document.createElement('style');
      style.id = styleId;
      style.innerHTML = `.forecast-zigzag-card:hover { box-shadow: 0 8px 32px #667eea33, 0 2px 8px #0001; transform: translateY(-4px) scale(1.04); border-color: #667eea !important; z-index:3; }`;
      document.head.appendChild(style);
    }
  }

  function showForecastDetail(idx) {
    const day = currentForecastData[idx];
    if (!day) {
      console.error('[Forecast] Invalid forecast day index:', idx);
      return;
    }
    
    let html = `<div class="mb-3 d-flex align-items-center gap-2" style="gap:10px;">
      <i class="fas fa-calendar-day" style="color:#667eea;font-size:1.3rem;"></i>
      <span style="font-size:1.1rem;font-weight:600;">${day.date}</span>
    </div>`;
    
    html += `<div class="row text-center mb-2" style="gap:0;">`;
    
    // PM2.5
    if (day.pm25_avg !== null && day.pm25_avg !== undefined) {
      html += `<div class="col-4 mb-3">
        <div style="font-size:1.2rem;"><i class="fas fa-smog" style="color:#4ecdc4;"></i></div>
        <div style="font-weight:600;font-size:1rem;">PM2.5</div>
        <div style="font-size:1.5rem;font-weight:700;color:#667eea;">${Math.round(day.pm25_avg)}</div>
        <div style="font-size:0.8em;color:#888;">min <span style="font-weight:500;">${day.pm25_min ?? '--'}</span> | max <span style="font-weight:500;">${day.pm25_max ?? '--'}</span></div>
      </div>`;
    }
    
    // PM10
    if (day.pm10_avg !== null && day.pm10_avg !== undefined) {
      html += `<div class="col-4 mb-3">
        <div style="font-size:1.2rem;"><i class="fas fa-wind" style="color:#45b7d1;"></i></div>
        <div style="font-weight:600;font-size:1rem;">PM10</div>
        <div style="font-size:1.5rem;font-weight:700;color:#667eea;">${Math.round(day.pm10_avg)}</div>
        <div style="font-size:0.8em;color:#888;">min <span style="font-weight:500;">${day.pm10_min ?? '--'}</span> | max <span style="font-weight:500;">${day.pm10_max ?? '--'}</span></div>
      </div>`;
    }
    
    // UVI
    if (day.uvi_avg !== null && day.uvi_avg !== undefined) {
      html += `<div class="col-4 mb-3">
        <div style="font-size:1.2rem;"><i class="fas fa-sun" style="color:#fbbf24;"></i></div>
        <div style="font-weight:600;font-size:1rem;">UVI</div>
        <div style="font-size:1.5rem;font-weight:700;color:#fbbf24;">${Math.round(day.uvi_avg)}</div>
        <div style="font-size:0.8em;color:#888;">min <span style="font-weight:500;">${day.uvi_min ?? '--'}</span> | max <span style="font-weight:500;">${day.uvi_max ?? '--'}</span></div>
      </div>`;
    }
    
    html += `</div>`;
    
    document.getElementById('forecastDetailBody').innerHTML = html;
    
    // Show modal (Bootstrap 4/5 compatible)
    if (window.$ && $.fn.modal) {
      $('#forecastDetailModal').modal('show');
    } else {
      document.getElementById('forecastDetailModal').style.display = 'block';
    }
  }

  // Show forecast after search result
  async function showForecastSection(stationId = null) {
    const card = document.getElementById('forecastCard');
    if (!card) {
      console.error('[Forecast] forecastCard not found in DOM');
      return;
    }
    if (card.style.display === 'none' || getComputedStyle(card).display === 'none') {
      card.style.display = 'block';
      console.log('[Forecast] forecastCard set to block');
    } else {
      console.log('[Forecast] forecastCard already visible');
    }

    // L·∫•y d·ªØ li·ªáu forecast t·ª´ API th·ª±c t·∫ø
    if (stationId) {
      console.log('[Forecast] Fetching forecast for station:', stationId);
      const forecastData = await fetchForecastData(stationId, 6);
      if (forecastData && forecastData.length > 0) {
        console.log('[Forecast] API forecast data:', forecastData);
        renderForecastGrid(forecastData);
      } else {
        console.warn('[Forecast] No forecast data available from API');
        const grid = document.getElementById('forecastGrid');
        if (grid) {
          grid.innerHTML = '<div class="col-12 text-center text-muted py-4">No forecast data available for this station.</div>';
        }
      }
    } else {
      console.warn('[Forecast] No station ID provided for forecast');
      const grid = document.getElementById('forecastGrid');
      if (grid) {
        grid.innerHTML = '<div class="col-12 text-center text-muted py-4">Select a station to view forecast data.</div>';
      }
    }
  }

  // Patch showLatestForStation and showCityStationsFromApi to show forecast after search
  (function() {
    function patchForecastHook(fnName) {
      const orig = window[fnName];
      if (typeof orig !== 'function') {
        console.warn(`[Forecast] ${fnName} is not defined, cannot patch`);
        return;
      }
      window[fnName] = async function(...args) {
        const result = await orig.apply(this, args);
        try {
          // L·∫•y station ID t·ª´ arguments
          let stationId = null;
          if (fnName === 'showLatestForStation' && args.length > 0) {
            stationId = args[0]; // Argument ƒë·∫ßu ti√™n l√† stationId
          }
          await showForecastSection(stationId);
        } catch (e) {
          console.error('[Forecast] showForecastSection error:', e);
        }
        return result;
      };
    }
    patchForecastHook('showLatestForStation');
    patchForecastHook('showCityStationsFromApi');
  })();
  </script>
        </div>
        <!-- End Dashboard Content -->

        <!-- Station Subscriptions Content -->
        <div id="subscriptions-content" style="display: none;">
          <div class="subscriptions-container">
            <div class="subscriptions-header">
              <h1>Station Subscriptions</h1>
              <p>Manage your subscribed stations, configure alert thresholds and notification preferences.</p>
            </div>

            <div class="subscriptions-controls">
              <div class="view-toggle" role="tablist" aria-label="View toggle">
                <button id="gridViewBtn" class="active" onclick="setView('grid')">Grid</button>
                <button id="listViewBtn" onclick="setView('list')">List</button>
              </div>

              <div class="sort-controls">
                <div class="subscription-count">Subscriptions <span id="subscriptionCount" class="count-badge">0</span></div>
              </div>
            </div>

            <div id="subscriptionsContainer">
              <div id="emptyState" class="empty-state" style="display:none;">
                <div class="empty-state-icon">üí®</div>
                <h3>No subscriptions yet</h3>
                <p>Subscribe to stations from the dashboard search to receive alerts and quick access to station details.</p>
                <button onclick="showDashboard()" class="explore-btn">Explore stations</button>
              </div>

              <div id="subscriptionsGrid" class="subscriptions-grid" aria-live="polite"></div>
              <div id="subscriptionsList" class="subscriptions-list" style="display:none;"></div>
            </div>
          </div>
        </div>
        <!-- End Station Subscriptions Content -->
      </div>

      <!-- Footer -->
      <footer class="footer">
        <div class="container-fluid">
          <ul class="nav">
          </ul>
        </div>
      </footer>
    </div>
  </div>

  <!-- Fixed plugin (theme switch) -->
  <div class="fixed-plugin">
    <div class="dropdown show-dropdown open">
      <a href="#" data-toggle="dropdown">
        <i class="fa fa-cog fa-2x"> </i>
      </a>
      <ul class="dropdown-menu">
        <li class="header-title"> Sidebar Background</li>
        <li class="adjustments-line">
          <a href="javascript:void(0)" class="switch-trigger background-color">
            <div class="badge-colors text-center">
              <span class="badge filter badge-primary active" data-color="primary"></span>
              <span class="badge filter badge-info" data-color="blue"></span>
              <span class="badge filter badge-success" data-color="green"></span>
              <span class="badge filter badge-warning" data-color="orange"></span>
              <span class="badge filter badge-danger" data-color="red"></span>
            </div>
            <div class="clearfix"></div>
          </a>
        </li>
      </ul>
    </div>
  </div>

{% block scripts %}
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/chartjs.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/bootstrap-notify.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/themeSettings.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/favorite_locations.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/station_subscriptions.js') }}"></script>
{% endblock %}

  <!-- Navigation Functions -->
  <script>
    let currentNavSection = 'dashboard';

    function showDashboard() {
      // Hide subscriptions content
      document.getElementById('subscriptions-content').style.display = 'none';
      // Show dashboard content  
      document.getElementById('dashboard-content').style.display = 'block';
      
      // Update navigation active states
      document.getElementById('dashboard-nav').classList.add('active');
      document.getElementById('subscriptions-nav').classList.remove('active');
      
      // Update navbar title
      document.querySelector('.navbar-brand').textContent = 'Dashboard';
      
      currentNavSection = 'dashboard';
    }

    function showSubscriptions() {
      // Hide dashboard content
      document.getElementById('dashboard-content').style.display = 'none';
      // Show subscriptions content
      document.getElementById('subscriptions-content').style.display = 'block';
      
      // Update navigation active states
      document.getElementById('dashboard-nav').classList.remove('active');
      document.getElementById('subscriptions-nav').classList.add('active');
      
      // Update navbar title
      document.querySelector('.navbar-brand').textContent = 'Station Subscriptions';
      
      // Initialize subscriptions if not already done, or refresh if already initialized
      if (typeof initializeSubscriptions === 'function') {
        initializeSubscriptions();
      } else if (typeof refreshSubscriptions === 'function') {
        refreshSubscriptions();
      }
      
      currentNavSection = 'subscriptions';
    }

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('access_token');
        window.location.href = '/login';
      }
    }

    // Initialize navigation on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure dashboard is shown by default
      showDashboard();
    });
  </script>

  <!-- AQI Color Classes -->
  <style>
    .aqi-good { color: #00e676; }
    .aqi-moderate { color: #ffd54f; }
    .aqi-unhealthy-sensitive { color: #ff9800; }
    .aqi-unhealthy { color: #f44336; }
    .aqi-very-unhealthy { color: #9c27b0; }
    .aqi-hazardous { color: #8d6e63; }
    
    /* Dark mode styles now handled by theme-switcher.css */
    
    .search-input:focus {
      outline: none;
      background: white;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    .search-btn:hover {
      background: #5a67d8;
      transform: translateY(-50%) scale(1.1);
    }
    
    .suggestion-item {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }
    
    .suggestion-item:hover {
      background: #f8f9ff;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .station-card:hover {
      border-color: #4facfe !important;
      background: #f0f8ff !important;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.1);
      transform: translateY(-2px);
    }
    .stations-list .aqi-badge {
      color: white !important;
      font-weight: 700;
    }
    .stations-list .aqi-good { background: #00e676 !important; margin-left: 0.5rem; }
    .stations-list .aqi-moderate { background: #ffd54f !important; margin-left: 0.5rem;}
    .stations-list .aqi-unhealthy-sensitive { background: #ff9800 !important;margin-left: 0.5rem; }
    .stations-list .aqi-unhealthy { background: #f44336 !important;margin-left: 0.5rem; }
    .stations-list .aqi-very-unhealthy { background: #9c27b0 !important; margin-left: 0.5rem;}
    .stations-list .aqi-hazardous { background: #8d6e63 !important; margin-left: 0.5rem;}
    
    .pollution-item:hover {
      border-color: #667eea;
      transform: translateY(-3px);
    }
    
    .quick-search-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
  </style>
  <style>
    #forecastDetailModal .modal-content {
      border-radius: 1.2rem;
      box-shadow: 0 8px 32px #667eea22, 0 2px 8px #0001;
      background: #fff;
      color: #222;
    }
    #forecastDetailModal .modal-header {
      background: linear-gradient(90deg,#667eea 0%,#764ba2 100%);
      color: #fff;
      border-radius: 1.2rem 1.2rem 0 0;
      border-bottom: none;
    }
    #forecastDetailModal .modal-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #e9e7e7;
    }
    #forecastDetailModal .modal-body {
      background: #f8f9ff;
      border-radius: 0 0 1.2rem 1.2rem;
      padding-top: 1.5rem;
      padding-bottom: 1.5rem;
      color: #222;
    }
    #forecastDetailModal .col-4 {
      border-right: 1px solid #e2e8f0;
    }
    #forecastDetailModal .col-4:last-child {
      border-right: none;
    }
    /* Modal dark mode styles now handled by theme-switcher.css */
  </style>

  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('citySearch');
    if (searchInput) {
      searchInput.addEventListener('input', handleSearchInput);
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleCitySearch();
        }
      });
    }

    // Listen for body class changes using MutationObserver (better than checkbox event)
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          // Delay ƒë·ªÉ ƒë·∫£m b·∫£o CSS ƒë∆∞·ª£c apply
          setTimeout(() => {
            if (currentForecastData) {
              console.log('[Theme Observer] Body class changed, refreshing forecast');
              console.log('[Theme Observer] Body classes:', document.body.className);
              renderForecastGrid(currentForecastData);
            }
          }, 150);
        }
      });
    });

    // B·∫Øt ƒë·∫ßu observe body class changes
    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ['class']
    });

    // Backup: Also listen for our header theme toggle button and trigger a refresh
    const headerThemeToggle = document.getElementById('themeToggle');
    if (headerThemeToggle) {
      headerThemeToggle.addEventListener('click', function() {
        // Toggle between light and dark mode using white-content class (compatible with existing system)
        const isCurrentlyLight = document.body.classList.contains('white-content');
        
        if (isCurrentlyLight) {
          // Switch to dark mode
          document.body.classList.remove('white-content');
          localStorage.setItem('light_color', 'false');
          this.querySelector('.fa-moon').style.display = 'none';
          this.querySelector('.fa-sun').style.display = 'inline-block';
          this.setAttribute('aria-pressed', 'false');
        } else {
          // Switch to light mode  
          document.body.classList.add('white-content');
          localStorage.setItem('light_color', 'true');
          this.querySelector('.fa-moon').style.display = 'inline-block';
          this.querySelector('.fa-sun').style.display = 'none';
          this.setAttribute('aria-pressed', 'true');
        }
        
        // Wait briefly for theme application then refresh dashboard pieces that depend on theme
        setTimeout(() => {
          if (currentForecastData) {
            console.log('[Theme] Header theme toggle clicked. Body classes:', document.body.className);
            renderForecastGrid(currentForecastData);
          }
        }, 300);
      });
    }

    // Initialize theme from localStorage to ensure dashboard matches auth pages
    (function initThemeFromStorage() {
      // Use the same localStorage key as themeSettings.js for consistency
      const savedLightColor = localStorage.getItem('light_color') || 'false';
      const isLight = savedLightColor === 'true';
      
      if (isLight) {
        document.body.classList.add('white-content');
      } else {
        document.body.classList.remove('white-content');
      }

      // Update theme toggle button appearance
      if (headerThemeToggle) {
        const moon = headerThemeToggle.querySelector('.fa-moon');
        const sun = headerThemeToggle.querySelector('.fa-sun');
        
        headerThemeToggle.classList.toggle('active', isLight);
        headerThemeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
        
        if (isLight) {
          moon.style.display = 'inline-block';
          sun.style.display = 'none';
        } else {
          moon.style.display = 'none';
          sun.style.display = 'inline-block';
        }
      }
    })();

    // Sync header theme toggle with fixed-plugin switcher
    $(document).ready(function() {
      // Override the fixed-plugin switch behavior to sync with header button
      $('.switch input').off('change').on('change', function() {
        const headerThemeToggle = document.getElementById('themeToggle');
        const isChecked = $(this).prop('checked');
        const isLight = !isChecked; // switch input checked = dark mode, unchecked = light mode
        
        if (isLight) {
          document.body.classList.add('white-content');
          localStorage.setItem('light_color', 'true');
        } else {
          document.body.classList.remove('white-content');
          localStorage.setItem('light_color', 'false');
        }
        
        // Update header button icons
        if (headerThemeToggle) {
          const moon = headerThemeToggle.querySelector('.fa-moon');
          const sun = headerThemeToggle.querySelector('.fa-sun');
          
          if (isLight) {
            moon.style.display = 'inline-block';
            sun.style.display = 'none';
          } else {
            moon.style.display = 'none';
            sun.style.display = 'inline-block';
          }
          headerThemeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
        }
        
        // Refresh forecast if available
        setTimeout(() => {
          if (currentForecastData) {
            renderForecastGrid(currentForecastData);
          }
        }, 300);
      });
      
      // Initialize fixed-plugin switch state
      const savedLightColor = localStorage.getItem('light_color') || 'false';
      const isLight = savedLightColor === 'true';
      $('.switch input').prop('checked', !isLight); // reversed: checked = dark, unchecked = light
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-input-group')) {
        const suggestionsEl = document.getElementById('searchSuggestions');
        if (suggestionsEl) suggestionsEl.style.display = 'none';
      }
    });

    // Initialize dashboard charts
    if (window.Chart) {
      const ctx = document.getElementById('aqiTrendChart');
      if (ctx) {
        new Chart(ctx.getContext('2d'), {
          type: 'line',
          data: {
            labels: Array.from({ length: 12 }, (_, i) => `${i+1}:00`),
            datasets: [{
              label: 'AQI',
              data: [42, 38, 45, 52, 48, 41, 39, 44, 50, 55, 49, 43],
              borderColor: 'rgb(79, 172, 254)',
              backgroundColor: 'rgba(79, 172, 254, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      const ctx2 = document.getElementById('pollutantChart');
      if (ctx2) {
        new Chart(ctx2.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['PM2.5', 'PM10', 'O‚ÇÉ', 'NO‚ÇÇ', 'SO‚ÇÇ', 'CO'],
            datasets: [{
              data: [30, 25, 20, 15, 6, 4],
              backgroundColor: ['#ff6b9d','#4ecdc4','#45b7d1','#96ceb4','#feca57','#ff9ff3'],
              borderWidth: 0
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
    }

    // ·∫®n forecastCard khi v·ª´a load trang
    const forecastCard = document.getElementById('forecastCard');
    if (forecastCard) forecastCard.style.display = 'none';
  });

  function handleSearchInput() {
    const cs = document.getElementById('citySearch');
    const queryRaw = cs ? cs.value : '';
    const query = queryRaw.trim();
    const suggestions = document.getElementById('searchSuggestions');
    if (suggestions) suggestions.style.display = 'none';
    if (suggestTimer) clearTimeout(suggestTimer);
    if (query.length < 2) return;
    suggestTimer = setTimeout(async () => {
      try {
        const items = [];
        // Numeric -> offer direct station ID search
        if (/^\d+$/.test(query)) {
          items.push({
            type: 'action',
            html: `
              <div class="suggestion-item" onclick="searchByStationId('${query}')">
              <strong>Search Station ID ${query}</strong>
              <small class="text-muted d-block">Show latest measurement if available</small>
              </div>`
          });
        }
        // Suggestions using stations API (by city filter to narrow scope)
        const cityParam = encodeURIComponent(query);
        const data = await fetchJSON(`/api/stations?city=${cityParam}&limit=10&offset=0`);
        if (data && Array.isArray(data.stations)) {
          // Also suggest station names that include the query
          const qLower = query.toLowerCase();
          const stationMatches = data.stations.filter(st => {
            const nm = (st.name || (st.city && st.city.name) || '').toString().toLowerCase();
            return nm.includes(qLower);
          }).slice(0, 5);
          stationMatches.forEach(st => {
            const stationId = st.station_id || (st._id || '').toString();
            const name = st.name || (st.city && st.city.name) || `Station ${stationId}`;
            items.unshift({
              type: 'station',
              html: `
                <div class="suggestion-item" onclick="selectStationFromList('${escapeAttr(String(stationId))}', '${escapeAttr(String(name))}')">
                <strong>${name}</strong>
                <small class="text-muted d-block">Station ID: ${stationId}</small>
                </div>`
            });
          });
        }
        if (items.length && suggestions) {
          suggestions.innerHTML = items.map(i => i.html).join('');
          suggestions.style.display = 'block';
        }
      } catch (e) {
        // Silently ignore suggestions errors
      }
    }, 250);
  }

  async function searchByStationId(stationId) {
    const cs = document.getElementById('citySearch');
    if (cs) cs.value = stationId;
    const suggestions = document.getElementById('searchSuggestions');
    if (suggestions) suggestions.style.display = 'none';
    await showLatestForStation(stationId);
  }

  function selectCity(cityName) {
    const cs = document.getElementById('citySearch');
    if (cs) cs.value = cityName;
    const suggestions = document.getElementById('searchSuggestions');
    if (suggestions) suggestions.style.display = 'none';
    showCityStationsFromApi(cityName);
  }

  function quickSearch(cityName) {
    const cs = document.getElementById('citySearch');
    if (cs) cs.value = cityName;
    showCityStationsFromApi(cityName);
  }

  async function handleCitySearch() {
    const csEl = document.getElementById('citySearch');
    const searchValue = csEl ? csEl.value.trim() : '';

    if (!searchValue) {
            alert('Please enter a city name, station name, or station ID');
            return;
        }
    // If numeric, try direct station lookup via API
    if (/^\d+$/.test(searchValue)) {
      await showLatestForStation(searchValue);
      return;
    }
    // Otherwise treat as a city name (API supports filtering by city only)
    await showCityStationsFromApi(searchValue);
    const closeSug = document.getElementById('searchSuggestions');
    if (closeSug) closeSug.style.display = 'none';
    }
  async function showCityStationsFromApi(cityName) {
    // Sau khi render xong, n·∫øu dark mode th√¨ remove background inline c·ªßa #stationsList v√† .station-card
    setTimeout(() => {
      const isDark = !document.body.classList.contains('white-content');
      if (isDark) {
        const stationsListEl = document.getElementById('stationsList');
        if (stationsListEl) stationsListEl.style.background = '';
        document.querySelectorAll('#stationsList .station-card').forEach(card => { card.style.background = ''; });
      }
    }, 0);
  // Hide default content and AQ section
  const defEl = document.getElementById('defaultContent');
  if (defEl) defEl.style.display = 'none';
  const resEl = document.getElementById('airQualityResult');
  if (resEl) resEl.style.display = 'none';
  // ·∫®n forecastCard khi ch·ªçn th√†nh ph·ªë (ch∆∞a ch·ªçn tr·∫°m)
  const forecastCard = document.getElementById('forecastCard');
  if (forecastCard) forecastCard.style.display = 'none';

    // Ensure stations list container exists
    let stationsListEl = document.getElementById('stationsList');
    if (!stationsListEl) {
      stationsListEl = document.createElement('div');
      stationsListEl.id = 'stationsList';
      stationsListEl.className = 'stations-list';
      // Detect dark mode: body KH√îNG c√≥ class 'white-content' = dark mode
      const isDark = !document.body.classList.contains('white-content');
      if (isDark) {
        stationsListEl.style.cssText = 'border-radius: 14px; padding: 1.5rem; box-shadow: 0 8px 28px rgba(22,24,33,0.08); margin-bottom: 1.75rem;';
      } else {
        stationsListEl.style.cssText = 'background: white; border-radius: 14px; padding: 1.5rem; box-shadow: 0 8px 28px rgba(22,24,33,0.08); margin-bottom: 1.75rem;';
      }
      const searchHeader = document.querySelector('.search-header');
      if (searchHeader && searchHeader.nextSibling) {
        searchHeader.parentNode.insertBefore(stationsListEl, searchHeader.nextSibling);
      }
    } else {
      // N·∫øu ƒë√£ t·ªìn t·∫°i, khi chuy·ªÉn dark mode th√¨ c≈©ng ki·ªÉm tra v√† set l·∫°i style
      const isDark = !document.body.classList.contains('white-content');
      if (isDark) {
        stationsListEl.style.cssText = 'border-radius: 14px; padding: 1.5rem; box-shadow: 0 8px 28px rgba(22,24,33,0.08); margin-bottom: 1.75rem; display: block;';
      }
    }

    stationsListEl.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="mb-1">Monitoring Stations in ${escapeHtml(cityName)}</h4>
        <p class="text-muted mb-0">Select a station to view detailed air quality data</p>
      </div>
      <button class="btn btn-outline-secondary btn-sm" onclick="goBackToSearch()">
        <i class="tim-icons icon-minimal-left"></i> Back to Search
      </button>
    </div>
    <div class="row" id="stationsGrid"><div class="col-12 text-center py-3">Loading stations‚Ä¶</div></div>`;

    const cityKey = cityName.toLowerCase();
    let stations = cityStationsCache.get(cityKey);
    if (!stations) {
      try {
        const data = await fetchJSON(`/api/stations?city=${encodeURIComponent(cityName)}&limit=50&offset=0`);
        stations = (data && data.stations) || [];
        cityStationsCache.set(cityKey, stations);
      } catch (e) {
        document.getElementById('stationsGrid').innerHTML = `<div class="col-12 text-danger">Failed to load stations</div>`;
        return;
      }
    }

    if (!stations.length) {
      document.getElementById('stationsGrid').innerHTML = `<div class="col-12 text-muted">No stations found for this city.</div>`;
      stationsListEl.style.display = 'block';
      return;
    }

    // Render basic cards first
    const cards = stations.map((st, idx) => {
      const stationId = st.station_id || (st._id || '').toString();
      const name = st.name || (st.city && st.city.name) || 'Station';
      const coords = st.location ? `${Number(st.location.latitude || 0).toFixed(3)}, ${Number(st.location.longitude || 0).toFixed(3)}` : '‚Äî';
      return `
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="station-card" data-station-id="${escapeHtml(String(stationId))}" onclick="selectStationFromList('${escapeAttr(String(stationId))}', '${escapeAttr(name)}')" style="border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.3s ease;">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-1" style="color: #1e293b; font-size: 0.9rem;">${escapeHtml(name)}</h6>
            <div class="aqi-badge" id="badge-${idx}" style="padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; background:#e2e8f0; color:#334155;">‚Äî</div>
          </div>
          <div class="station-preview">
            <div class="row text-center mb-2">
            <div class="col-6">
              <div class="small text-muted">Station ID</div>
              <div class="font-weight-bold text-primary">${escapeHtml(String(stationId))}</div>
            </div>
            <div class="col-6">
              <div class="small text-muted">Status</div>
              <div class="small" id="status-${idx}">‚Äî</div>
            </div>
            </div>
            <div class="row text-center">
            <div class="col-6">
              <div class="small text-muted">PM2.5</div>
              <div class="font-weight-bold" id="pm25-${idx}">‚Äî</div>
            </div>
            <div class="col-6">
              <div class="small text-muted">Coordinates</div>
              <div class="small text-muted">${coords}</div>
            </div>
            </div>
          </div>
          </div>
        </div>`;
    }).join('');
    document.getElementById('stationsGrid').innerHTML = cards;
    stationsListEl.style.display = 'block';

    // Enrich with latest AQI per station (one-by-one; small N)
    stations.forEach(async (st, idx) => {
      const stationId = st.station_id || (st._id || '').toString();
      try {
        const latest = await getLatestForStation(stationId);
        if (!latest) return;
        const aqi = latest.aqi ?? '‚Äî';
        const pm25 = latest.pm25 ?? '‚Äî';
        const statusObj = typeof aqi === 'number' ? getAQIStatus(aqi) : null;
        const badge = document.getElementById(`badge-${idx}`);
        const statusEl = document.getElementById(`status-${idx}`);
        const pmEl = document.getElementById(`pm25-${idx}`);
        if (badge && statusObj) {
          badge.className = `aqi-badge ${statusObj.class}`;
          badge.textContent = aqi;
        }
        if (statusEl && statusObj) statusEl.textContent = statusObj.status;
        if (pmEl) pmEl.textContent = pm25 !== '‚Äî' ? `${pm25} Œºg/m¬≥` : '‚Äî';
      } catch (e) {
        // ignore per-card errors
      }
    });
  }

  async function selectStationFromList(stationId, stationName) {
    // Hide stations list
    const stationsListEl = document.getElementById('stationsList');
    if (stationsListEl) stationsListEl.style.display = 'none';
    // Show result
    await showLatestForStation(stationId, stationName);
  }

    function goBackToSearch() {
        // Hide stations list
        const stationsListEl = document.getElementById('stationsList');
        if (stationsListEl) stationsListEl.style.display = 'none';
        
        // Hide air quality result
        const resEl = document.getElementById('airQualityResult');
        if (resEl) resEl.style.display = 'none';
        
        // Show default content
        const defEl = document.getElementById('defaultContent');
        if (defEl) defEl.style.display = 'block';
        
        // Clear search input
        const cs = document.getElementById('citySearch');
        if (cs) cs.value = '';
    }

  async function showLatestForStation(stationId, fallbackName) {
    try {
      const latest = await getLatestForStation(stationId);
      if (!latest) {
        alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho Station ID n√†y.');
        return;
      }
      // Hide default and stations list
      const defEl = document.getElementById('defaultContent');
      if (defEl) defEl.style.display = 'none';
      const stationsListEl = document.getElementById('stationsList');
      if (stationsListEl) stationsListEl.style.display = 'none';
      // Show result panel
      const resEl = document.getElementById('airQualityResult');
      if (resEl) resEl.style.display = 'block';

      // Hi·ªÉn th·ªã forecastCard ngay sau khi c√≥ k·∫øt qu·∫£ tr·∫°m
      const forecastCard = document.getElementById('forecastCard');
      if (forecastCard) {
        forecastCard.style.display = 'block';
        // L·∫•y d·ªØ li·ªáu forecast t·ª´ API cho tr·∫°m n√†y
        const forecastData = await fetchForecastData(latest.station_id, 6);
        if (forecastData && forecastData.length > 0) {
          renderForecastGrid(forecastData);
        } else {
          const grid = document.getElementById('forecastGrid');
          if (grid) {
            grid.innerHTML = '<div class="col-12 text-center text-muted py-4">No forecast data available for this station.</div>';
          }
        }
      } else {
        console.warn('[Forecast] forecastCard not found in DOM from showLatestForStation');
      }

      // Location/station name
      const locEl = document.getElementById('locationName');
      const displayName = latest.station_name || fallbackName || `Station ${latest.station_id}`;
      if (locEl) locEl.textContent = displayName;

      // Map fields
      const aqi = latest.aqi ?? 0;
      const pm25 = latest.pm25 ?? '‚Äî';
      const pm10 = latest.pm10 ?? '‚Äî';
      const o3 = latest.o3 ?? '‚Äî';
      const no2 = latest.no2 ?? '‚Äî';
      const ts = latest.timestamp || null;

      const elAqiValue = document.getElementById('aqiValue');
      const elPm25 = document.getElementById('pm25Value');
      const elPm10 = document.getElementById('pm10Value');
      const elO3 = document.getElementById('o3Value');
      const elNo2 = document.getElementById('no2Value');
      const elAqiStatus = document.getElementById('aqiStatus');
      const elAqiDesc = document.getElementById('aqiDescription');

      if (elAqiValue) elAqiValue.textContent = aqi;
      if (elPm25) elPm25.textContent = pm25;
      if (elPm10) elPm10.textContent = pm10;
      if (elO3) elO3.textContent = o3;
      if (elNo2) elNo2.textContent = no2;

      const aqiStatusObj = getAQIStatus(Number(aqi));
      if (elAqiStatus) elAqiStatus.textContent = aqiStatusObj.status;
      if (elAqiDesc) elAqiDesc.textContent = aqiStatusObj.description;
      if (elAqiValue) elAqiValue.className = `aqi-value ${aqiStatusObj.class}`;
      if (elAqiStatus) elAqiStatus.className = `aqi-status ${aqiStatusObj.class}`;

      // Timestamp display
      const tsEl = document.getElementById('timestampValue');
      if (tsEl) {
        tsEl.textContent = ts ? `Updated: ${formatTimestamp(ts)}` : 'Updated: ‚Äî';
      }

      // Temperature & Humidity from latest measurement (fields 't' and 'h')
      const elTemp = document.getElementById('temperature');
      const elHum = document.getElementById('weatherHumidity');
      const tempVal = latest.t ?? latest.temp ?? latest.temperature ?? null;
      const humVal = latest.h ?? latest.humidity ?? null;
      if (elTemp) elTemp.textContent = (tempVal !== null && tempVal !== undefined) ? `${tempVal}¬∞C` : '--';
      if (elHum) elHum.textContent = (humVal !== null && humVal !== undefined) ? `${humVal}%` : '--';

      // Update trend chart using 12-hour history API for this station
      const trendCanvas = document.getElementById('aqiSearchTrendChart');
      if (trendCanvas && window.Chart) updateSearchTrendChartFromApi(String(latest.station_id || stationId), 12);
      
      // Update subscription button state
      const stationData = {
        station_id: latest.station_id || stationId,
        station_name: displayName,
        location: displayName
      };
      updateSubscriptionButton(stationData);
    } catch (e) {
      alert('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu tr·∫°m.');
    }
  }

  async function getLatestForStation(stationId) {
    if (latestCache.has(stationId)) return latestCache.get(stationId);
    const data = await fetchJSON(`/api/air-quality/latest?station_id=${encodeURIComponent(stationId)}&limit=1`);
    const latest = data && Array.isArray(data.measurements) && data.measurements.length ? data.measurements[0] : null;
    if (latest) latestCache.set(stationId, latest);
    return latest;
  }

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  // Small helpers to safely inject text
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  function escapeAttr(str) {
    return escapeHtml(str).replace(/"/g, '&quot;');
  }
  function formatTimestamp(ts) {
    try {
      // Accepts ISO strings or epoch millis
      const d = typeof ts === 'number' ? new Date(ts) : new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      // Format as local time: YYYY-MM-DD HH:mm
      const pad = (n) => n.toString().padStart(2, '0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    } catch (_) {
      return String(ts);
    }
  }

    function getAQIStatus(aqi) {
        if (aqi <= 50) {
            return {
                status: 'Good',
                class: 'aqi-good',
                description: 'Air quality is considered satisfactory, and air pollution poses little or no risk.'
            };
        } else if (aqi <= 100) {
            return {
                status: 'Moderate',
                class: 'aqi-moderate',
                description: 'Air quality is acceptable; however, some pollutants may be a concern for sensitive people.'
            };
        } else if (aqi <= 150) {
            return {
                status: 'Unhealthy (S)',
                class: 'aqi-unhealthy-sensitive',
                description: 'Members of sensitive groups may experience health effects.'
            };
        } else if (aqi <= 200) {
            return {
                status: 'Unhealthy',
                class: 'aqi-unhealthy',
                description: 'Everyone may begin to experience health effects.'
            };
        } else if (aqi <= 300) {
            return {
                status: 'Very Unhealthy',
                class: 'aqi-very-unhealthy',
                description: 'Health warnings of emergency conditions.'
            };
        } else {
            return {
                status: 'Hazardous',
                class: 'aqi-hazardous',
                description: 'Health alert: everyone may experience serious health effects.'
            };
        }
    }
  
  async function updateSearchTrendChartFromApi(stationId, hours = 12) {
    const canvasEl = document.getElementById('aqiSearchTrendChart');
    if (!canvasEl) return;
    const ctx = canvasEl.getContext('2d');

    // fetch history from API
    const fetchHours = hours === 12 ? 24 : Math.max(hours, 12);
    let measurements = [];
    try {
      const resp = await fetchJSON(`/api/aq/history?station_id=${encodeURIComponent(stationId)}&hours=${encodeURIComponent(fetchHours)}`);
      if (resp && Array.isArray(resp.measurements)) {
        measurements = resp.measurements;
      }
    } catch (_) {
      measurements = [];
    }

    // Build 12-hour window labels and AQI series aligned to current half-day
    const now = new Date();
    const rawHour = now.getHours();
    const slotCount = Math.max(1, hours);
    const isAfternoon = rawHour >= 13;
    const rangeStart = isAfternoon ? 13 : 1;
    const hourSlots = Array.from({ length: slotCount }, (_, idx) => {
      const slot = rangeStart + idx;
      return ((slot - 1) % 24) + 1;
    });

    const rangeStartDate = new Date(now);
    rangeStartDate.setMinutes(0, 0, 0);
    rangeStartDate.setHours(isAfternoon ? 13 : 1, 0, 0, 0);
    const rangeEndDate = new Date(rangeStartDate);
    rangeEndDate.setHours(rangeEndDate.getHours() + slotCount);

    const latestByHour = new Map();
    for (const m of measurements) {
      const d = new Date(m.timestamp);
      if (isNaN(d.getTime())) continue;
      if (d < rangeStartDate || d >= rangeEndDate) continue;
      let hour = d.getHours();
      if (hour === 0) hour = 24;
      const existing = latestByHour.get(hour);
      if (!existing) {
        latestByHour.set(hour, m);
        continue;
      }
      const existingTime = new Date(existing.timestamp);
      if (!isNaN(existingTime.getTime()) && existingTime < d) {
        latestByHour.set(hour, m);
      }
    }

    const labels = [];
    const aqiData = [];
    for (const slot of hourSlots) {
      const labelHour = slot === 24 ? '24' : String(slot).padStart(2, '0');
      labels.push(`${labelHour}:00`);
      const measurement = latestByHour.get(slot);
      if (measurement && measurement.aqi !== null && measurement.aqi !== undefined && !Number.isNaN(Number(measurement.aqi))) {
        const value = Number(measurement.aqi);
        aqiData.push(value < 0 ? 0 : value);
      } else {
        aqiData.push(null);
      }
    }

    console.log('DEBUG: aqiData =', aqiData); // Debug log

    // Color per bar
    const barColors = aqiData.map(v => {
      if (typeof v !== 'number' || Number.isNaN(v)) return 'rgba(0,0,0,0.2)';
      if (v <= 50) return '#00e676';
      if (v <= 100) return '#ffd54f';
      if (v <= 150) return '#ff9800';
      if (v <= 200) return '#f44336';
      if (v <= 300) return '#9c27b0';
      return '#8d6e63';
    });

    if (aqiChart) aqiChart.destroy();

    const numericValues = aqiData.filter(v => typeof v === 'number' && !Number.isNaN(v));
    const avg = numericValues.length ? Math.round(numericValues.reduce((s, v) => s + v, 0) / numericValues.length) : 0;
    const statusObj = getAQIStatus(avg);
    const summaryEl = document.getElementById('aqiTrendSummary');
    if (summaryEl) {
      summaryEl.innerHTML = `
        <div style="font-weight:700;color:#b58d00;">${avg} AQI* US <span style="font-weight:600;color:#b58d00">${statusObj.status}</span></div>
        <div style="font-size:0.9rem;color:#666;">Hourly</div>
      `;
    }

    // Detect dark mode: body KH√îNG c√≥ class 'white-content' = dark mode
    const isDark = !document.body.classList.contains('white-content');
    
    // Force chart max ƒë·ªÉ tr√°nh auto-scale
    const validValues = aqiData.filter(v => typeof v === 'number' && !Number.isNaN(v) && v > 0);
    const maxValue = validValues.length ? Math.max(...validValues) : 50;
    const chartMax = Math.max(100, Math.ceil(maxValue / 25) * 25); // Round to nearest 25
    
    // FORCE th√™m ƒëi·ªÉm d·ªØ li·ªáu ·∫©n t·∫°i 0 ƒë·ªÉ ƒë·∫£m b·∫£o tr·ª•c y b·∫Øt ƒë·∫ßu t·ª´ 0 (append to end)
    const forceLabels = [...labels];
    const forceAqiData = [...aqiData];
    const forceColors = [...barColors];
    
    // Add an invisible zero bar if no existing values touch the baseline
    const hasZeroOrBelow = forceAqiData.some(v => typeof v === 'number' && !Number.isNaN(v) && v <= 0);
    if (!hasZeroOrBelow) {
      forceLabels.push(''); // Empty label at the end
      forceAqiData.push(0);
      forceColors.push('rgba(0,0,0,0)'); // Transparent
    }
    
    console.log('DEBUG: chartMax =', chartMax); // Debug log
    console.log('DEBUG: forceAqiData =', forceAqiData); // Debug log
    
    aqiChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: forceLabels,
        datasets: [{
          label: 'AQI',
          data: forceAqiData,
          backgroundColor: forceColors,
          borderRadius: 6,
          borderSkipped: false,
          maxBarThickness: 14
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            left: 5,
            right: 5,
            top: 5,
            bottom: 5
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) { return `AQI: ${context.parsed.y}`; }
            },
            backgroundColor: isDark ? '#23263a' : '#fff',
            titleColor: isDark ? '#fff' : '#222',
            bodyColor: isDark ? '#fff' : '#222',
            borderColor: isDark ? '#35395a' : '#eee',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            min: 0,
            max: chartMax,
            grid: { display: false },
            ticks: {
              color: isDark ? '#fff' : '#222',
              font: { weight: 'bold' },
              stepSize: 25,
              callback: function(value) { 
                return value;
              }
            }
          },
          x: {
            grid: { display: false },
            ticks: { 
              maxRotation: 0, 
              minRotation: 0, 
              color: isDark ? '#fff' : '#222', 
              font: { weight: 'bold' },
              autoSkip: true,
              maxTicksLimit: 12
            }
          }
        }
      }
    });
  }
  
  // Station Subscription Management
  let currentStationData = null; // Store current selected station info
  
  // Check if station is already subscribed
  async function isStationSubscribed(stationId) {
    try {
      const token = localStorage.getItem('access_token');
      const response = await fetch('/api/subscriptions', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) return false;
      
      const data = await response.json();
      return data.subscriptions.some(sub => sub.station_id === stationId);
    } catch (error) {
      console.error('Error checking subscription:', error);
      return false;
    }
  }
  
  // Toggle station subscription
  async function toggleStationSubscription() {
    if (!currentStationData) {
      alert('Please select a station first');
      return;
    }
    
    const subscribeBtn = document.getElementById('subscribeBtn');
    const heartIcon = subscribeBtn.querySelector('.heart-icon');
    const isCurrentlySubscribed = subscribeBtn.classList.contains('subscribed');
    
    try {
      const token = localStorage.getItem('access_token');
      
      if (isCurrentlySubscribed) {
        // Unsubscribe
        const response = await fetch('/api/subscriptions/unsubscribe', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            station_id: currentStationData.station_id
          })
        });
        
        if (response.ok) {
          subscribeBtn.classList.remove('subscribed');
          subscribeBtn.title = 'Subscribe to station alerts';
          showNotification('Station unsubscribed successfully', 'success');
          if (typeof refreshSubscriptions === 'function') refreshSubscriptions();
        } else {
          const errorData = await response.json();
          showNotification(errorData.error || 'Failed to unsubscribe', 'error');
        }
      } else {
        // Subscribe
        const response = await fetch('/api/subscriptions/subscribe', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            station_id: currentStationData.station_id,
            station_name: currentStationData.station_name || currentStationData.location,
            nickname: currentStationData.station_name || currentStationData.location,
            threshold: 100, // Default threshold
            alert_enabled: true
          })
        });
        
        if (response.ok) {
          subscribeBtn.classList.add('subscribed');
          subscribeBtn.title = 'Unsubscribe from station alerts';
          showNotification('Station subscribed successfully', 'success');
          if (typeof refreshSubscriptions === 'function') refreshSubscriptions();
        } else {
          const errorData = await response.json();
          if (errorData.error && errorData.error.includes('limit')) {
            showNotification('You can only subscribe to 10 stations maximum', 'warning');
          } else {
            showNotification(errorData.error || 'Failed to subscribe', 'error');
          }
        }
      }
    } catch (error) {
      console.error('Error toggling subscription:', error);
      showNotification('Network error occurred', 'error');
    }
  }
  
  // Update subscription button state
  async function updateSubscriptionButton(stationData) {
    currentStationData = stationData;
    const subscribeBtn = document.getElementById('subscribeBtn');
    
    if (!subscribeBtn) return;
    
    // Check if already subscribed
    const isSubscribed = await isStationSubscribed(stationData.station_id);
    
    if (isSubscribed) {
      subscribeBtn.classList.add('subscribed');
      subscribeBtn.title = 'Unsubscribe from station alerts';
    } else {
      subscribeBtn.classList.remove('subscribed');
      subscribeBtn.title = 'Subscribe to station alerts';
    }
  }
  
  // Show notification
  function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notification && notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
  
  </script>
</body>
</html>
