
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='js/assets/img/apple-icon.png') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='js/assets/img/favicon.png') }}">
  <title>Reset Password | Air Quality Monitor</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <!-- Auth Styles -->

  <link href="{{ url_for('static', filename='js/assets/css/two-column-auth.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/auth-overrides.css') }}" rel="stylesheet" />
  
  <style>
    .password-rules {
      font-size: 0.8rem;
      margin-top: 10px;
    }
    .password-rules .rule {
      margin-bottom: 5px;
    }
    .rule-valid {
      color: #00d4aa;
    }
    .rule-invalid {
      color: #fd5d93;
    }

    /* Password toggle positioning */
    .form-group .password-toggle,
    .input-inline .password-toggle {
      position: absolute !important;
      right: 8px !important;
      top: 46% !important;
      transform: translateY(-46%) !important;
      height: 32px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 8px !important;
      color: inherit !important;
      background: transparent !important;
      border: none !important;
    }
    /* ensure parent creating positioning context */
    .form-group > div { position: relative; }

    /* Normalize browser autocomplete/autofill appearance and selection styling */
    /* Remove harsh autofill background colors - adapt to theme */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px rgba(255,255,255,0.05) inset !important;
      -webkit-text-fill-color: inherit !important;
      caret-color: inherit !important;
      transition: background-color 5000s ease-in-out 0s !important;
    }

    /* Theme-specific autocomplete styling */
    [data-theme="light"] input:-webkit-autofill,
    [data-theme="light"] input:-webkit-autofill:hover,
    [data-theme="light"] input:-webkit-autofill:focus,
    [data-theme="light"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #ffffff inset !important;
      -webkit-text-fill-color: #333333 !important;
      background-color: #ffffff !important;
    }

    [data-theme="dark"] input:-webkit-autofill,
    [data-theme="dark"] input:-webkit-autofill:hover,
    [data-theme="dark"] input:-webkit-autofill:focus,
    [data-theme="dark"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #2c2c2c inset !important;
      -webkit-text-fill-color: #ffffff !important;
      background-color: #2c2c2c !important;
    }

    /* Hide autocomplete dropdown arrow */
    input::-webkit-calendar-picker-indicator,
    input::-webkit-clear-button,
    input::-webkit-search-cancel-button,
    input::-webkit-search-decoration {
      display: none !important;
      -webkit-appearance: none !important;
    }

    /* Selection styling for dark/light themes */
    input::selection {
      background: rgba(255, 77, 166, 0.3) !important;
      color: inherit !important;
    }

    /* Focus styling normalization */
    input:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    /* Autocomplete suggestion list styling override */
    input[autocomplete]::-webkit-contacts-auto-fill-button {
      visibility: hidden !important;
      display: none !important;
    }
   /* Polished compact alert used on auth pages (prevents layout shift) */
   /* The container is absolutely positioned inside the form wrapper so alerts overlay
     and do not push or reflow the surrounding layout. On small screens we fall back
     to normal flow and center the alert below the form. */
   #alertContainer { position: absolute; top: 24px; right: 24px; z-index: 80; }
   .aqm-alert-wrapper { display:block; }
    .aqm-alert { max-width:420px; width:100%; border-radius:12px; padding:10px 14px; display:flex; gap:10px; align-items:center; box-shadow:0 8px 24px rgba(4,10,25,0.08); font-size:0.98rem; }
    .aqm-alert .aqm-icon { flex:0 0 36px; height:36px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:#fff; }
    .aqm-alert .aqm-body { flex:1 1 auto; }
    .aqm-alert .aqm-close { background:transparent; border:none; color:inherit; font-size:1.05rem; }
    .aqm-alert-success { background:#e8fff7; color:#055b46; }
    .aqm-alert-success .aqm-icon { background:#00d4aa; }
    .aqm-alert-danger { background:#fff1f5; color:#7a0b2b; }
    .aqm-alert-danger .aqm-icon { background:#fd5d93; }
    /* Responsive: on small viewports don't overlay (avoid clipping) */
    @media (max-width: 767px) {
      #alertContainer { position: static; margin-top: 18px; display:flex; justify-content:center; }
      .aqm-alert { margin: 0 12px; }
    }
  </style>
</head>

<body class="login-page">
  <div class="wrapper wrapper-full-page">
    <div class="full-page login-page section-image" data-color="black" data-image="{{ url_for('static', filename='js/assets/img/full-screen-image-2.jpg') }}">
      <!--   Big container   -->
      <div class="content">
        <div class="container-fluid">
          <div class="row min-vh-100">
            <!-- Left Side - GIF -->
            <div class="col-lg-6 col-md-6 p-0 d-flex align-items-stretch">
              <div class="w-100 h-100" style="overflow:hidden;">
                <img src="{{ url_for('static', filename='js/assets/img/test.gif') }}" alt="Air Quality Animation" style="object-fit:cover;width:100%;height:100vh;">
              </div>
            </div>
            <!-- Right Side - Form -->
            <div id="rightColumn" class="col-lg-6 col-md-6 d-flex align-items-center justify-content-lg-end justify-content-center bg-white dark-bg">
              <div class="auth-form-wrapper w-100 d-flex flex-column align-items-center justify-content-center" style="max-width:none; padding:48px; min-height:100vh; position:relative;">
                <div class="theme-toggle-container" style="position:absolute;top:18px;right:20px;z-index:50;">
                  <button id="themeToggle" class="theme-toggle btn btn-link" type="button" aria-pressed="false" aria-label="Toggle theme">
                    <i class="fas fa-moon" aria-hidden="true"></i>
                    <i class="fas fa-sun" aria-hidden="true"></i>
                  </button>
                </div>

                <form class="form w-100" id="resetForm" style="max-width:400px;margin:0 auto;">
                  <div class="card-header bg-transparent">
                    <div class="card-header-text text-center">
                      <h3 class="card-title mb-2" style="font-size:2.4rem;font-weight:800;margin-bottom:0.5rem;letter-spacing:-1px;">Reset Password</h3>
                      <p class="card-category mb-0" style="font-size:1.18rem;font-weight:500;letter-spacing:-0.5px;margin-bottom:0.2rem;">Enter your new password below</p>
                    </div>
                  </div>
                  <div class="card-body p-0 d-flex flex-column align-items-center justify-content-center w-100" style="min-height: 350px;">
                      <input type="hidden" id="token" value="{{ request.args.get('token', '') }}">

                      <div class="form-group mb-4 w-100">
                        <div style="background:rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 2px 12px rgba(2,6,23,0.10);display:flex;align-items:center;padding:0 0.75rem;height:56px;">
                          <span style="color:#ff4da6;font-size:1.4rem;display:flex;align-items:center;margin-right:12px;"><i class="tim-icons icon-lock-circle"></i></span>
                          <input type="password" class="form-control border-0 bg-transparent" id="new_password" placeholder="Enter new password" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;">
                          <button type="button" class="btn btn-link password-toggle" aria-label="Toggle password visibility" style="color:rgba(0,0,0,0.6);font-size:1.05rem;padding:0 8px;margin-left:6px;top:50% !important;">
                            <i class="fas fa-eye-slash" aria-hidden="true"></i>
                          </button>
                        </div>
                      </div>

                      <div class="form-group mb-4 w-100">
                        <div style="background:rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 2px 12px rgba(2,6,23,0.10);display:flex;align-items:center;padding:0 0.75rem;height:56px;">
                          <span style="color:#ff4da6;font-size:1.4rem;display:flex;align-items:center;margin-right:12px;"><i class="tim-icons icon-lock-circle"></i></span>
                          <input type="password" class="form-control border-0 bg-transparent" id="confirm_password" placeholder="Confirm new password" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;">
                          <button type="button" class="btn btn-link password-toggle" aria-label="Toggle password visibility" style="color:rgba(0,0,0,0.6);font-size:1.05rem;padding:0 8px;margin-left:6px; top:50% !important;">
                            <i class="fas fa-eye-slash" aria-hidden="true"></i>
                          </button>
                        </div>
                      </div>

                      <small class="text-muted">Password must contain:</small>
                      <div class="password-rules">
                        <div class="rule rule-invalid" id="rule-length">
                          <i class="fas fa-times"></i>
                          <span>At least 8 characters</span>
                        </div>
                        <div class="rule rule-invalid" id="rule-upper">
                          <i class="fas fa-times"></i>
                          <span>One uppercase letter</span>
                        </div>
                        <div class="rule rule-invalid" id="rule-lower">
                          <i class="fas fa-times"></i>
                          <span>One lowercase letter</span>
                        </div>
                        <div class="rule rule-invalid" id="rule-digit">
                          <i class="fas fa-times"></i>
                          <span>One number</span>
                        </div>
                        <div class="rule rule-invalid" id="rule-special">
                          <i class="fas fa-times"></i>
                          <span>One special character</span>
                        </div>
                        <div class="rule rule-invalid" id="rule-match">
                          <i class="fas fa-times"></i>
                          <span>Passwords match</span>
                        </div>
                      </div>
                    </div>
                    <div class="bg-transparent mt-2 text-center">
                      <button type="submit" id="resetBtn" class="btn btn-primary btn-lg btn-block" style="border-radius:12px;">Reset Password</button>
                      <div class="auth-footer-links">
                        <a href="/login" class="link footer-link">Back to Sign In</a>
                        <span>Don't have an account? <a href="/register" class="link footer-link">Sign Up</a></span>
                      </div>
                    </div>
                  </div>
                </form>

                <!-- Alert for showing results -->
                <div id="alertContainer" style="margin-top: 20px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--   Core JS Files   -->
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
  <!-- Control Center for Black Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}"></script>

  <script>
    $(document).ready(function() {
      // Prefill token from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      if (token) {
        $('#token').val(token);
      }

      // Real-time password validation
      $('#new_password, #confirm_password').on('input', function() {
        validatePassword();
      });
    });

    // Unified theme toggle: data-theme on :root + localStorage and legacy class syncing
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const rightColumn = document.getElementById('rightColumn');

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.querySelectorAll('.dark-bg').forEach(function(el){
          if (theme === 'light') { el.classList.remove('bg-dark'); el.classList.add('bg-white'); }
          else { el.classList.remove('bg-white'); el.classList.add('bg-dark'); }
        });
        if (rightColumn) {
          if (theme === 'light') { rightColumn.classList.remove('bg-dark'); rightColumn.classList.add('bg-white'); }
          else { rightColumn.classList.remove('bg-white'); rightColumn.classList.add('bg-dark'); }
        }
      }

      const savedTheme = localStorage.getItem('theme') || 'dark';
      applyTheme(savedTheme);

      if (themeToggle) {
        const isLight = savedTheme === 'light';
        themeToggle.classList.toggle('active', isLight);
        themeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');

        themeToggle.addEventListener('click', function() {
          const current = document.documentElement.getAttribute('data-theme') || 'dark';
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', next);
          applyTheme(next);
          const nowLight = next === 'light';
          themeToggle.classList.toggle('active', nowLight);
          themeToggle.setAttribute('aria-pressed', nowLight ? 'true' : 'false');
        });
      }
    });

    function showAlert(message, type = 'danger') {
      const container = document.getElementById('alertContainer');
      if (!container) return;
      const esc = (s) => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const wrapper = document.createElement('div');
      wrapper.className = 'aqm-alert-wrapper';
      wrapper.innerHTML = `\n        <div class="aqm-alert aqm-alert-${type === 'success' ? 'success' : 'danger'}" role="status" aria-live="polite">\n          <div class="aqm-icon" aria-hidden="true">${type === 'success' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-exclamation-triangle"></i>'}</div>\n          <div class="aqm-body">${esc(message)}</div>\n          <button class="aqm-close" aria-label="Dismiss">&times;</button>\n        </div>\n      `;
      container.innerHTML = '';
      container.appendChild(wrapper);

      const alertEl = container.querySelector('.aqm-alert');
      const closeBtn = container.querySelector('.aqm-close');
      function removeAlert() {
        if (!alertEl) return;
        alertEl.style.transition = 'opacity 160ms ease, transform 160ms ease';
        alertEl.style.opacity = '0';
        alertEl.style.transform = 'translateY(6px)';
        setTimeout(() => { if (container) container.innerHTML = ''; }, 180);
      }
      if (closeBtn) closeBtn.addEventListener('click', removeAlert);
      setTimeout(removeAlert, 5000);
    }

    function validatePassword() {
      const password = $('#new_password').val() || '';
      const confirmPassword = $('#confirm_password').val() || '';
      
      const rules = {
        length: password.length >= 8,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        digit: /\d/.test(password),
        special: /[^\w\s]/.test(password),
        match: password === confirmPassword && password.length > 0
      };

      // Update rule indicators
      Object.keys(rules).forEach(rule => {
        const element = $(`#rule-${rule}`);
        const icon = element.find('i');
        
        if (rules[rule]) {
          element.removeClass('rule-invalid').addClass('rule-valid');
          icon.removeClass('fa-times').addClass('fa-check');
        } else {
          element.removeClass('rule-valid').addClass('rule-invalid');
          icon.removeClass('fa-check').addClass('fa-times');
        }
      });

      // Enable/disable submit button
      const allValid = Object.values(rules).every(v => v);
      $('#resetBtn').prop('disabled', !allValid);
      
      return allValid;
    }

    $('#resetForm').on('submit', async function(e) {
      e.preventDefault();
      
      const token = $('#token').val().trim();
      const newPassword = $('#new_password').val();
      const confirmPassword = $('#confirm_password').val();
      
      // Validate inputs
      if (!token || !newPassword || !confirmPassword) {
        showAlert('Please fill in all fields');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showAlert('Passwords do not match');
        return;
      }
      
      if (!validatePassword()) {
        showAlert('Password does not meet requirements');
        return;
      }

      // Check if new password is same as old password
      try {
        const checkResponse = await fetch('/api/auth/check-password-reuse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            token: token, 
            new_password: newPassword 
          })
        });

        if (checkResponse.ok) {
          const checkData = await checkResponse.json();
          if (checkData.is_same) {
            showAlert('New password cannot be the same as your current password.');
            return;
          }
        }
      } catch (error) {
        console.log('Password reuse check failed:', error);
        // Continue with reset if check fails - don't block user
      }
      
      // Disable button during submission
      const submitBtn = $('#resetBtn');
      const originalText = submitBtn.text();
      submitBtn.prop('disabled', true).text('Resetting...');
      
      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: token,
            new_password: newPassword
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Reset successful
          showAlert('Password reset successfully! Redirecting to login...', 'success');
          
          // Clear form
          $('#resetForm')[0].reset();
          
          // Redirect to login after short delay
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
          
        } else {
          // Reset failed
          showAlert(data.message || 'Password reset failed. Please check your token and try again.');
        }
        
      } catch (error) {
        console.error('Password reset error:', error);
        showAlert('An error occurred. Please try again.');
      } finally {
        // Re-enable button
        submitBtn.prop('disabled', false).text(originalText);
      }
    });

    // Ensure English validation messages for reset form (passwords)
    (function enforceResetValidation() {
      const newPwd = document.getElementById('new_password');
      const confirmPwd = document.getElementById('confirm_password');
      if (!newPwd || !confirmPwd) return;

      // Store old password hash/check - we'll validate against server
      let isCheckingOldPassword = false;

      async function checkIfSameAsOldPassword(newPassword) {
        if (!newPassword || isCheckingOldPassword) return false;
        
        try {
          isCheckingOldPassword = true;
          const token = $('#token').val().trim();
          if (!token) return false;

          const response = await fetch('/api/auth/check-password-reuse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token: token, 
              new_password: newPassword 
            })
          });

          if (response.ok) {
            const data = await response.json();
            return data.is_same || false;
          }
        } catch (error) {
          console.log('Password reuse check failed:', error);
        } finally {
          isCheckingOldPassword = false;
        }
        return false;
      }

      async function setPwdMessages() {
        // Clear previous
        newPwd.setCustomValidity('');
        confirmPwd.setCustomValidity('');

        // Required checks
        if (!newPwd.value) {
          newPwd.setCustomValidity('Please enter a new password.');
          return;
        }
        if (!confirmPwd.value) {
          confirmPwd.setCustomValidity('Please confirm your new password.');
          return;
        }

        // Check if same as old password
        if (newPwd.value && await checkIfSameAsOldPassword(newPwd.value)) {
          newPwd.setCustomValidity('New password cannot be the same as your current password.');
          return;
        }

        // Match check
        if (newPwd.value && confirmPwd.value && newPwd.value !== confirmPwd.value) {
          confirmPwd.setCustomValidity('Passwords do not match.');
        }
      }

      newPwd.setAttribute('required', '');
      confirmPwd.setAttribute('required', '');

      // Debounce password checks to avoid too many API calls
      let debounceTimer;
      function debouncedSetPwdMessages() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(setPwdMessages, 500);
      }

      newPwd.addEventListener('input', debouncedSetPwdMessages, false);
      confirmPwd.addEventListener('input', setPwdMessages, false);
      newPwd.addEventListener('invalid', setPwdMessages, false);
      confirmPwd.addEventListener('invalid', setPwdMessages, false);
    })();

    // Password visibility toggles (support multiple toggle buttons)
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.password-toggle').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          // find the closest input within the same wrapper
          const wrapper = btn.closest('.form-group') || btn.parentElement;
          const input = wrapper.querySelector('input[type="password"], input[type="text"]');
          if (!input) return;
          const icon = btn.querySelector('i');
          if (input.type === 'password') {
            input.type = 'text';
            if (icon) { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
          } else {
            input.type = 'password';
            if (icon) { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
          }
        });
      });
    });
  </script>
</body>

</html>

