<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='js/assets/img/apple-icon.png') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='js/assets/img/favicon.png') }}">
  <title>Forgot Password | Air Quality Monitor</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <!-- Black Dashboard Auth Styles -->
  <link href="{{ url_for('static', filename='js/assets/css/two-column-auth.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/auth-overrides.css') }}" rel="stylesheet" />
  
  <style>
    /* Normalize browser autocomplete/autofill appearance and selection styling */
    /* Remove harsh autofill background colors - adapt to theme */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px rgba(255,255,255,0.05) inset !important;
      -webkit-text-fill-color: inherit !important;
      caret-color: inherit !important;
      transition: background-color 5000s ease-in-out 0s !important;
    }

    /* Theme-specific autocomplete styling */
    [data-theme="light"] input:-webkit-autofill,
    [data-theme="light"] input:-webkit-autofill:hover,
    [data-theme="light"] input:-webkit-autofill:focus,
    [data-theme="light"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #ffffff inset !important;
      -webkit-text-fill-color: #333333 !important;
      background-color: #ffffff !important;
    }

    [data-theme="dark"] input:-webkit-autofill,
    [data-theme="dark"] input:-webkit-autofill:hover,
    [data-theme="dark"] input:-webkit-autofill:focus,
    [data-theme="dark"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #2c2c2c inset !important;
      -webkit-text-fill-color: #ffffff !important;
      background-color: #2c2c2c !important;
    }

    /* Hide autocomplete dropdown arrow */
    input::-webkit-calendar-picker-indicator,
    input::-webkit-clear-button,
    input::-webkit-search-cancel-button,
    input::-webkit-search-decoration {
      display: none !important;
      -webkit-appearance: none !important;
    }

    /* Selection styling for dark/light themes */
    input::selection {
      background: rgba(255, 77, 166, 0.3) !important;
      color: inherit !important;
    }

    /* Focus styling normalization */
    input:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    /* Autocomplete suggestion list styling override */
    input[autocomplete]::-webkit-contacts-auto-fill-button {
      visibility: hidden !important;
      display: none !important;
    }
  </style>
</head>

<body class="login-page">
  <div class="wrapper wrapper-full-page">
    <div class="full-page login-page section-image" data-color="black" data-image="{{ url_for('static', filename='js/assets/img/full-screen-image-2.jpg') }}">
      <!--   Big container   -->
      <div class="container-fluid">
        <div class="row min-vh-100">
          <!-- Left Side - GIF -->
          <div class="col-lg-6 col-md-6 p-0 d-flex align-items-stretch">
            <div class="w-100 h-100" style="overflow:hidden;">
              <img src="{{ url_for('static', filename='js/assets/img/test.gif') }}" alt="Air Quality Animation" style="object-fit:cover;width:100%;height:100vh;">
            </div>
          </div>
          <!-- Right Side - Form -->
          <div id="rightColumn" class="col-lg-6 col-md-6 d-flex align-items-center justify-content-center bg-white dark-bg">
            <div class="auth-form-wrapper w-100 d-flex flex-column align-items-center justify-content-center" style="max-width:none; padding:48px; min-height:100vh; position:relative;">
              <!-- Top-right toggle container (absolute inside right column) -->
              <div class="theme-toggle-container" style="position:absolute;top:18px;right:20px;z-index:50;">
                <button id="themeToggle" class="theme-toggle btn btn-link" type="button" aria-pressed="false" aria-label="Toggle theme">
                  <i class="fas fa-moon" aria-hidden="true"></i>
                  <i class="fas fa-sun" aria-hidden="true"></i>
                </button>
              </div>
              <form class="form w-100" id="forgotForm" style="max-width:400px;margin:0 auto;">
                <div class="card-header bg-transparent">
                  <div class="card-header-text text-center">
                    <h3 class="card-title mb-2">Forgot Password</h3>
                    <p class="card-category mb-0">Enter your email to reset your password</p>
                  </div>
                </div>
                <div class="mb-3 w-100">
                  <div class="form-group mb-4 w-100">
                    <div style="background:rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 2px 12px rgba(2,6,23,0.10);display:flex;align-items:center;padding:0 1.2rem;height:56px;">
                      <span style="color:#ff4da6;font-size:1.4rem;display:flex;align-items:center;"><i class="tim-icons icon-email-85"></i></span>
                      <input type="email" class="form-control border-0 bg-transparent" name="email" id="email" placeholder="Email" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;">
                    </div>
                  </div>
                </div>
                <div class="bg-transparent mt-2 d-flex flex-column align-items-center w-100">
                  <button type="submit" class="btn btn-primary btn-block py-2 mt-2" style="font-size:1.13rem;width:100%;margin:0 auto;">Send Reset Link</button>
                  <div class="auth-footer-links mt-3 w-100">
                    <span style="font-size:1rem;display:block;width:100%;text-align:center;">Remembered? <a href="/login" class="link footer-link">Sign In</a></span>
                  </div>
                </div>
              </form>
              <!-- The user will be redirected to a dedicated verify-code page after submitting their email -->
              <!-- Alert for showing results -->
              <div id="alertContainer" style="margin-top: 20px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <!-- <script src="{{ url_for('static', filename='js/assets/js/plugins/bootstrap-switch.js') }}"></script> -->
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <!-- <script src="{{ url_for('static', filename='js/assets/js/plugins/nouislider.min.js') }}"></script> -->
  <!-- Control Center for Black Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}"></script>

  <script>
    function showAlert(message, type = 'danger') {
      const alertContainer = $('#alertContainer');
      const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <span class="alert-text">${message}</span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      `;
      alertContainer.html(alertHTML);
      
      // Auto hide after 8 seconds for forgot password
      setTimeout(() => {
        alertContainer.find('.alert').fadeOut();
      }, 8000);
    }

    $('#forgotForm').on('submit', async function(e) {
      e.preventDefault();
      
      const email = $('#email').val().trim();
      
      if (!email) {
        showAlert('Please enter your email address');
        return;
      }
      
      // Disable button during submission
      const submitBtn = $(this).find('button[type="submit"]');
      const originalText = submitBtn.text();
      submitBtn.prop('disabled', true).text('Sending...');
      
      try {
        const response = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Inspect returned JSON for whether the user exists. The server
          // keeps the top-level message generic to avoid enumeration, but
          // exposes a small `user_exists` flag for client UX.
          const exists = data && data.user_exists === true;
          if (!exists) {
            // User does not exist: stay on the same page and show a helpful message.
            showAlert('No account found for that email. Please check the address or register a new account.', 'warning');
            // Keep the entered email so the user can correct it; do not redirect.
            $('#email').focus();
          } else {
            showAlert('If an account exists with this email, you will receive a reset token shortly. You will be redirected to the code verification page.', 'success');
            $('#email').val(''); // Clear form
            setTimeout(() => {
              window.location.href = `/verify-code`;
            }, 1200);
          }
        } else {
          // For security, still show success message and redirect to verify-code
          showAlert('If an account exists with this email, you will receive a reset token shortly. You will be redirected to the code verification page.', 'success');
          setTimeout(() => {
            window.location.href = `/verify-code`;
          }, 1200);
        }

        
      } catch (error) {
        console.error('Forgot password error:', error);
        showAlert('If an account exists with this email, you will receive a reset token shortly.', 'success');
      } finally {
        // Re-enable button
        submitBtn.prop('disabled', false).text(originalText);
      }
    });

    // Ensure English custom validation messages for forgot form (immediate, robust)
    (function enforceEnglishValidation() {
      const email = document.getElementById('email');
      if (!email) return;

      // Ensure required and helpful attributes
      email.setAttribute('required', '');
      email.setAttribute('autocomplete', 'email');

      function updateMessage() {
        // Clear first
        email.setCustomValidity('');

        // If valid, nothing to do
        if (email.validity.valid) return;

        // Prioritize specific messages to emulate common browser copy
        if (email.validity.valueMissing) {
          email.setCustomValidity('Please enter your email address.');
        } else if (email.validity.typeMismatch) {
          email.setCustomValidity('Please include an "@" in the email address.');
        } else {
          email.setCustomValidity('Please enter a valid email address.');
        }
      }

      // Update message on input and blur so the browser uses our English text instead of localized defaults
      email.addEventListener('input', updateMessage, false);
      email.addEventListener('blur', updateMessage, false);
      email.addEventListener('invalid', function(e) { updateMessage(); }, false);
    })();

    // No in-page token input anymore; users are redirected to /verify-code
  </script>
  <script>
    // Unified theme toggle: data-theme on :root + localStorage and legacy class syncing
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const rightColumn = document.getElementById('rightColumn');

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.querySelectorAll('.dark-bg').forEach(function(el){
          if (theme === 'light') { el.classList.remove('bg-dark'); el.classList.add('bg-white'); }
          else { el.classList.remove('bg-white'); el.classList.add('bg-dark'); }
        });
        if (rightColumn) {
          if (theme === 'light') { rightColumn.classList.remove('bg-dark'); rightColumn.classList.add('bg-white'); }
          else { rightColumn.classList.remove('bg-white'); rightColumn.classList.add('bg-dark'); }
        }
      }

      const savedTheme = localStorage.getItem('theme') || 'dark';
      applyTheme(savedTheme);

      if (themeToggle) {
        const isLight = savedTheme === 'light';
        themeToggle.classList.toggle('active', isLight);
        themeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');

        themeToggle.addEventListener('click', function() {
          const current = document.documentElement.getAttribute('data-theme') || 'dark';
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', next);
          applyTheme(next);
          const nowLight = next === 'light';
          themeToggle.classList.toggle('active', nowLight);
          themeToggle.setAttribute('aria-pressed', nowLight ? 'true' : 'false');
        });
      }
    });
  </script>
</body>

</html>

