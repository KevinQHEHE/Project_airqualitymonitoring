<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='js/assets/img/apple-icon.png') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='js/assets/img/favicon.png') }}">
  <title>Verify Code | Air Quality Monitor</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/two-column-auth.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/auth-overrides.css') }}" rel="stylesheet" />
</head>

<body class="login-page">
  <div class="wrapper wrapper-full-page">
    <div class="full-page login-page section-image" data-color="black" data-image="{{ url_for('static', filename='js/assets/img/full-screen-image-2.jpg') }}">
      <div class="container-fluid">
        <div class="row min-vh-100">
          <div class="col-lg-6 col-md-6 p-0 d-flex align-items-stretch">
            <div class="w-100 h-100" style="overflow:hidden;">
              <img src="{{ url_for('static', filename='js/assets/img/test.gif') }}" alt="Air Quality Animation" style="object-fit:cover;width:100%;height:100vh;">
            </div>
          </div>
          <div id="rightColumn" class="col-lg-6 col-md-6 d-flex align-items-center justify-content-lg-end justify-content-center bg-white dark-bg" style="position:relative;">
            <div class="theme-toggle-container" style="position:absolute;top:18px;right:20px;z-index:50;">
              <button id="themeToggle" class="theme-toggle btn btn-link" type="button" aria-pressed="false" aria-label="Toggle theme">
                <i class="fas fa-moon" aria-hidden="true"></i>
                <i class="fas fa-sun" aria-hidden="true"></i>
              </button>
            </div>
            <div class="auth-form-wrapper w-100 d-flex flex-column align-items-center justify-content-center" style="max-width:none; padding:48px; min-height:100vh;">
              <form class="form w-100" id="verifyForm" style="max-width:400px;margin:0 auto;">
                <div class="card-header bg-transparent text-center">
                  <h3 class="card-title mb-1">Verify Reset Code</h3>
                  <p class="card-category mb-0">Enter the code we sent to your email</p>
                  {% if email %}
                  <p class="text-muted small mt-1">We've sent the token to <strong>{{ email }}</strong></p>
                  {% endif %}
                </div>
                <div class="card-body p-0 d-flex flex-column align-items-center justify-content-center w-100" style="min-height: 120px;">
                  <div class="form-group mb-4 w-100">
                    <div style="background:rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 2px 12px rgba(2,6,23,0.10);display:flex;align-items:center;padding:0 1.2rem;height:56px;">
                      <span style="color:#ff4da6;font-size:1.4rem;display:flex;align-items:center;"><i class="tim-icons icon-key-25"></i></span>
                      <input id="tokenInput" type="text" class="form-control border-0 bg-transparent" name="verificationCode" placeholder="Verification Code" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;">
                    </div>
                  </div>
                </div>
                <div class="bg-transparent mt-2 d-flex flex-column align-items-center w-100">
                  <button type="submit" class="btn btn-primary btn-block py-2 mt-2" style="font-size:1.13rem;width:100%;margin:0 auto;">Verify</button>
                  <div class="auth-footer-links mt-3 w-100">
                    <span style="font-size:1rem;display:block;width:100%;text-align:center;"><a href="/forgot-password" class="link">Back</a></span>
                  </div>
                </div>
              </form>
              <div id="alertContainer" style="margin-top: 20px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}"></script>

  <script>
    function showAlert(message, type = 'danger') {
      const alertContainer = $('#alertContainer');
      const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <span class="alert-text">${message}</span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      `;
      alertContainer.html(alertHTML);
      setTimeout(() => { alertContainer.find('.alert').fadeOut(); }, 5000);
    }

    $('#verifyForm').on('submit', async function(e) {
      e.preventDefault();
      const token = $('#tokenInput').val().trim();
      if (!token) { showAlert('Please enter the token you received'); return; }

      try {
        const resp = await fetch('/api/auth/verify-reset-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token })
        });

        if (resp.ok) {
          const encoded = encodeURIComponent(token);
          window.location.href = `/reset-password?token=${encoded}`;
        } else {
          const data = await resp.json().catch(() => ({}));
          showAlert(data.error || 'Invalid or expired token. Please request a new one.');
        }
      } catch (err) {
        console.error('Token verification error:', err);
        showAlert('An error occurred while verifying the token. Please try again.');
      }
    });
  </script>
  <script>
    // Robust theme toggle: toggles [data-theme] on documentElement and syncs legacy classes
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const rightColumn = document.getElementById('rightColumn');

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        // sync legacy class-based backgrounds for compatibility
        document.querySelectorAll('.dark-bg').forEach(function(el){
          if (theme === 'light') {
            el.classList.remove('bg-dark');
            el.classList.add('bg-white');
          } else {
            el.classList.remove('bg-white');
            el.classList.add('bg-dark');
          }
        });
        // Also update rightColumn explicitly if present
        if (rightColumn) {
          if (theme === 'light') {
            rightColumn.classList.remove('bg-dark');
            rightColumn.classList.add('bg-white');
          } else {
            rightColumn.classList.remove('bg-white');
            rightColumn.classList.add('bg-dark');
          }
        }
      }

      // initialize from localStorage or prefer dark
      let theme = localStorage.getItem('theme') || 'dark';
      applyTheme(theme);

      if (themeToggle) {
        // set accessible pressed state based on current theme
        const isLight = theme === 'light';
        themeToggle.classList.toggle('active', isLight);
        themeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');

  // rely on .active class + CSS to show correct icon state
  const moonIcon = themeToggle.querySelector('.fa-moon');
  const sunIcon = themeToggle.querySelector('.fa-sun');
        themeToggle.addEventListener('click', function() {
          theme = (document.documentElement.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
          localStorage.setItem('theme', theme);
          applyTheme(theme);
          const isNowLight = theme === 'light';
          themeToggle.classList.toggle('active', isNowLight);
          themeToggle.setAttribute('aria-pressed', isNowLight ? 'true' : 'false');
        });
      }
    });
  </script>
</body>

</html>
