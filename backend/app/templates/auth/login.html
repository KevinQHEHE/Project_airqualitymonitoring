<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='js/assets/img/apple-icon.png') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='js/assets/img/favicon.png') }}">
  <title>Login | Air Quality Monitor</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="{{ url_for('static', filename='js/assets/css/nucleo-icons.css') }}" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="{{ url_for('static', filename='js/assets/css/black-dashboard.min.css') }}" rel="stylesheet" />
  <!-- Black Dashboard Auth Styles -->

  <link href="{{ url_for('static', filename='js/assets/css/two-column-auth.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/assets/css/auth-overrides.css') }}" rel="stylesheet" />
  <style>
    /* Normalize browser autocomplete/autofill appearance and selection styling (match register page)
       This reduces the harsh default highlight when a datalist option or autofill is applied. */
    input[list]::-webkit-calendar-picker-indicator,
    input[list]::-webkit-clear-button,
    input[list]::-webkit-outer-spin-button,
    input[list]::-webkit-inner-spin-button {
      display: none !important;
      -webkit-appearance: none;
      appearance: none;
    }

    /* Specifically hide the clear/dropdown arrow in WebKit/Blink */
    input[list]::-webkit-search-cancel-button,
    input[list]::-webkit-search-decoration { display: none !important; }

    /* Firefox (uses a built-in dropmarker) */
    input[list]::-moz-focus-inner { border: 0; }
    input[list]::-moz-drop-down-button { display: none; }

    /* As a fallback, hide an explicit background image if present */
    input[list] { background-image: none !important; }

    /* Normalize browser autofill styles so the field doesn't get a harsh yellow/blue box */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px rgba(255,255,255,0.03) inset !important;
      -webkit-text-fill-color: inherit !important;
      caret-color: inherit !important;
      transition: background-color 5000s ease-in-out 0s !important;
    }

    /* Theme-specific autocomplete styling */
    [data-theme="light"] input:-webkit-autofill,
    [data-theme="light"] input:-webkit-autofill:hover,
    [data-theme="light"] input:-webkit-autofill:focus,
    [data-theme="light"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #ffffff inset !important;
      -webkit-text-fill-color: #333333 !important;
      background-color: #ffffff !important;
    }

    [data-theme="dark"] input:-webkit-autofill,
    [data-theme="dark"] input:-webkit-autofill:hover,
    [data-theme="dark"] input:-webkit-autofill:focus,
    [data-theme="dark"] input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #2c2c2c inset !important;
      -webkit-text-fill-color: #ffffff !important;
      background-color: #2c2c2c !important;
    }

    /* Hide other picker controls */
    input::-webkit-calendar-picker-indicator,
    input::-webkit-clear-button,
    input::-webkit-search-cancel-button,
    input::-webkit-search-decoration { display: none !important; -webkit-appearance: none !important; }

    /* Selection styling for dark/light themes */
    input::selection { background: rgba(255, 77, 166, 0.3) !important; color: inherit !important; }

    /* Focus styling normalization */
    input:focus { outline: none !important; box-shadow: none !important; }

    /* Autocomplete suggestion list styling override */
    input[autocomplete]::-webkit-contacts-auto-fill-button { visibility: hidden !important; display: none !important; }
  </style>
  <style>
    /* Ensure password toggle is absolutely positioned inside its wrapper and top is honored.
       Use a specific selector and !important to override bootstrap or other rules that may
       reset positioning in some browsers or stylesheets. */
    .input-inline .password-toggle,
    .form-group .password-toggle {
      position: absolute !important;
      right: 8px !important;
      top: 46% !important;
      transform: translateY(-46%) !important;
      height: 32px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 8px !important;
      color: inherit !important;
      background: transparent !important;
      border: none !important;
    }
    /* make sure parent is a positioning context */
    .input-inline { position: relative; }
  </style>
</head>

<body class="login-page">
  <div class="wrapper wrapper-full-page">
    <div class="full-page login-page section-image" data-color="black" data-image="{{ url_for('static', filename='js/assets/img/full-screen-image-2.jpg') }}">
      <!--   Big container   -->
      <div class="content">
        <div class="container-fluid">
          <div class="row min-vh-100">
            <!-- Left Side - GIF -->
            <div class="col-lg-6 col-md-6 p-0 d-flex align-items-stretch">
              <div class="w-100 h-100" style="overflow:hidden;">
                <img src="{{ url_for('static', filename='js/assets/img/test.gif') }}" alt="Air Quality Animation" style="object-fit:cover;width:100%;height:100vh;">
              </div>
            </div>
            <!-- Right Side - Form -->
            <div id="rightColumn" class="col-lg-6 col-md-6 d-flex align-items-center justify-content-lg-end justify-content-center bg-white dark-bg" style="position:relative;">
              <!-- Theme toggle placed at the top-right of this column -->
              <div class="theme-toggle-container" style="position:absolute;top:18px;right:20px;z-index:50;">
                <button id="themeToggle" class="theme-toggle btn btn-link" type="button" title="Toggle Theme" aria-pressed="false" aria-label="Toggle theme">
                  <i class="fas fa-moon" aria-hidden="true"></i>
                  <i class="fas fa-sun" aria-hidden="true"></i>
                </button>
              </div>
              <div class="auth-form-wrapper w-100" style="max-width: none; padding: 48px;">
                <form class="form" id="loginForm" style="max-width:400px;margin:0 auto;">
                  <div class="card-header bg-transparent" style="margin-bottom:1.5rem;">
                    <div class="card-header-text text-center" style="margin-bottom:0;">
                      <h3 class="card-title mb-2" style="font-size:2.4rem;font-weight:800;margin-bottom:0.5rem;letter-spacing:-1px;">Welcome Back</h3>
                      <p class="card-category mb-0" style="font-size:1.18rem;font-weight:500;letter-spacing:-0.5px;margin-bottom:0.2rem;">Sign In To Access Your Air Quality Dashboard</p>
                    </div>
                  </div>
                  <div class="mb-3 d-flex flex-column align-items-center justify-content-center">
                    <div class="form-group mb-3 w-100" style="max-width:400px;">
                      <label class="text-white" style="font-weight:600;">Username</label>
                      <div class="input-inline" style="background:rgba(255,255,255,0.02);border-radius:12px;display:flex;align-items:center;padding:0 1rem;height:56px;">
                        <span class="input-left" style="color:#ff4da6;font-size:1.25rem;display:flex;align-items:center;margin-right:12px;"><i class="tim-icons icon-single-02"></i></span>
                        <!-- Added datalist for remembered usernames -->
                        <input list="rememberedUsernames" type="text" class="form-control border-0 bg-transparent" name="username" id="username" placeholder="Enter your username" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;">
                        <datalist id="rememberedUsernames"></datalist>
                      </div>
                    </div>

                    <div class="form-group mb-3 w-100" style="max-width:400px;">
                      <label class="text-white" style="font-weight:600;">Password</label>
                      <div class="input-inline" style="background:rgba(255,255,255,0.02);border-radius:12px;display:flex;align-items:center;padding:0 0.75rem;height:56px;position:relative;">
                        <span class="input-left" style="color:#ff4da6;font-size:1.25rem;display:flex;align-items:center;margin-right:12px;"><i class="tim-icons icon-lock-circle"></i></span>
                        <input type="password" class="form-control border-0 bg-transparent" name="password" id="password" placeholder="Enter your password" required style="padding-left:0;box-shadow:none;height:100%;font-size:1.08rem;flex:1;padding-right:40px;">
                        <button type="button" class="btn btn-link password-toggle" aria-label="Toggle password visibility" style="color:rgba(255,255,255,0.9);font-size:1.05rem;padding:0 8px;position:absolute;right:8px;top:46%;transform:translateY(-46%);height:32px;display:flex;align-items:center;justify-content:center;">
                          <i class="fas fa-eye-slash" aria-hidden="true"></i>
                        </button>
                      </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-between w-100" style="max-width:400px;">
                      <div class="form-check" style="text-align:left;">
                        <label class="form-check-label" style="font-size:1rem;color:rgba(255,255,255,0.9);">
                          <input class="form-check-input" type="checkbox" id="rememberMe">
                          <span class="form-check-sign"></span>
                          Remember me
                        </label>
                      </div>
                      <div>
                        <a href="/forgot" class="link footer-link" style="font-size:1rem;color:#ff6ea6;">Forgot Password?</a>
                      </div>
                    </div>
                  </div>
                  <div class="bg-transparent">
                      <button type="submit" class="btn btn-primary btn-block py-2 mt-2" style="font-size:1.13rem;max-width:400px;width:100%;margin:0 auto;">Sign In</button>
                      <div class="auth-footer-links" style="max-width:400px;width:100%;margin:0 auto;">
                        <span style="font-size:1rem;">Don't have an account? <a href="/register" class="link footer-link">Sign Up</a></span>
                      </div>
                  </div>
                </form>
                <!-- Alert for showing results -->
                <div id="alertContainer" style="margin-top: 20px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="{{ url_for('static', filename='js/assets/js/core/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/assets/js/plugins/perfect-scrollbar.jquery.min.js') }}"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <!-- <script src="{{ url_for('static', filename='js/assets/js/plugins/bootstrap-switch.js') }}"></script> -->
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <!-- <script src="{{ url_for('static', filename='js/assets/js/plugins/nouislider.min.js') }}"></script> -->
  <!-- Control Center for Black Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{{ url_for('static', filename='js/assets/js/black-dashboard.min.js') }}"></script>

  <script>
    // Theme toggle (unified)
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const rightColumn = document.getElementById('rightColumn');

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.querySelectorAll('.dark-bg').forEach(function(el){
          if (theme === 'light') { el.classList.remove('bg-dark'); el.classList.add('bg-white'); }
          else { el.classList.remove('bg-white'); el.classList.add('bg-dark'); }
        });
        if (rightColumn) {
          if (theme === 'light') { rightColumn.classList.remove('bg-dark'); rightColumn.classList.add('bg-white'); }
          else { rightColumn.classList.remove('bg-white'); rightColumn.classList.add('bg-dark'); }
        }
      }

      const savedTheme = localStorage.getItem('theme') || 'dark';
      applyTheme(savedTheme);

      if (themeToggle) {
        const isLight = savedTheme === 'light';
        themeToggle.classList.toggle('active', isLight);
        themeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');

        themeToggle.addEventListener('click', function(e) {
          e.preventDefault();
          const current = document.documentElement.getAttribute('data-theme') || 'dark';
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', next);
          applyTheme(next);
          const nowLight = next === 'light';
          themeToggle.classList.toggle('active', nowLight);
          themeToggle.setAttribute('aria-pressed', nowLight ? 'true' : 'false');
        });
      }
      // Check if user is already logged in
      const token = localStorage.getItem('access_token');
      if (token) {
        // Verify token is still valid
        verifyToken(token);
      }
    });

    function showAlert(message, type = 'danger') {
      const alertContainer = $('#alertContainer');
      const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <span class="alert-text">${message}</span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      `;
      alertContainer.html(alertHTML);
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        alertContainer.find('.alert').fadeOut();
      }, 5000);
    }
    // JS fallback: ensure inline styles applied with high specificity so devtools doesn't cross out `top`
    (function forcePasswordTogglePosition() {
      const els = document.querySelectorAll('.password-toggle');
      els.forEach(el => {
        // Use CSSOM to set style priority via setProperty
        el.style.setProperty('position', 'absolute', 'important');
        el.style.setProperty('right', '8px', 'important');
        el.style.setProperty('top', '46%', 'important');
        el.style.setProperty('transform', 'translateY(-46%)', 'important');
        el.style.setProperty('height', '32px', 'important');
        el.style.setProperty('display', 'flex', 'important');
        el.style.setProperty('align-items', 'center', 'important');
        el.style.setProperty('justify-content', 'center', 'important');
        el.style.setProperty('padding', '0 8px', 'important');
      });
    })();

    async function verifyToken(token) {
      try {
        const response = await fetch('/api/auth/verify', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          // Token is valid, redirect to dashboard
          window.location.href = '/';
        } else {
          // Token is invalid, remove it
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
        }
      } catch (error) {
        console.error('Token verification failed:', error);
      }
    }

    // Password visibility toggle
    document.addEventListener('DOMContentLoaded', function() {
      const pwdToggle = document.querySelector('.password-toggle');
      if (pwdToggle) {
        pwdToggle.addEventListener('click', function() {
          const input = document.getElementById('password');
          const icon = pwdToggle.querySelector('i');
          if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          } else {
            input.type = 'password';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          }
        });
      }
    });

    // ==========================
    // Remember Me client logic
    // Stores a map of remembered credentials in localStorage under key 'remembered_credentials'
    // Each entry is { username: string, password: base64String }
    // Warning: storing passwords in localStorage is sensitive. This implements the user's requested behavior
    // but stores passwords only encoded with base64 (not secure encryption). Consider using more secure storage.
    // ==========================

    function getRemembered() {
      try {
        const raw = localStorage.getItem('remembered_credentials');
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error('Failed to parse remembered_credentials', e);
        return {};
      }
    }

    function saveRemembered(obj) {
      localStorage.setItem('remembered_credentials', JSON.stringify(obj));
    }

    function encodePwd(pwd) {
      return btoa(unescape(encodeURIComponent(pwd)));
    }

    function decodePwd(encoded) {
      try {
        return decodeURIComponent(escape(atob(encoded)));
      } catch (e) {
        return '';
      }
    }

    // Prefill username/password and populate datalist
    document.addEventListener('DOMContentLoaded', function() {
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const rememberCheckbox = document.getElementById('rememberMe');
      const datalist = document.getElementById('rememberedUsernames');

      const remembered = getRemembered();

      // Populate datalist
      function refreshDatalist() {
        datalist.innerHTML = '';
        Object.keys(remembered).forEach(u => {
          const opt = document.createElement('option');
          opt.value = u;
          datalist.appendChild(opt);
        });
      }
      refreshDatalist();

      // If there's a last remembered username, prefill it and check the box
      const last = localStorage.getItem('last_remembered_username');
      if (last && remembered[last]) {
        usernameInput.value = last;
        passwordInput.value = decodePwd(remembered[last]);
        rememberCheckbox.checked = true;
      } else if (last) {
        // if last is stored but not present in remembered map, clear last
        localStorage.removeItem('last_remembered_username');
      }

      // When username input changes (including via datalist selection), if it's a remembered user autofill password
      usernameInput.addEventListener('input', function() {
        const val = usernameInput.value;
        if (remembered[val]) {
          passwordInput.value = decodePwd(remembered[val]);
          rememberCheckbox.checked = true;
        } else {
          // clear password when input doesn't match
          passwordInput.value = '';
          // leave checkbox as-is
        }
        // Clear any custom validity message when user types
        usernameInput.setCustomValidity('');
      });

      // Provide English custom validation messages (override browser localized text)
      function setEnglishValidationMessages() {
        if (usernameInput) {
          usernameInput.addEventListener('invalid', function(e) {
            // Only set message when required constraint fails
            if (!usernameInput.value) {
              usernameInput.setCustomValidity('Please enter your username.');
            }
          });
          usernameInput.addEventListener('input', function() { usernameInput.setCustomValidity(''); });
        }
        if (passwordInput) {
          passwordInput.addEventListener('invalid', function(e) {
            if (!passwordInput.value) {
              passwordInput.setCustomValidity('Please enter your password.');
            }
          });
          passwordInput.addEventListener('input', function() { passwordInput.setCustomValidity(''); });
        }
      }
      setEnglishValidationMessages();

      // When remember checkbox is unchecked, remove the currently shown username from remembered
      rememberCheckbox.addEventListener('change', function() {
        const u = usernameInput.value;
        if (!rememberCheckbox.checked && u && remembered[u]) {
          delete remembered[u];
          saveRemembered(remembered);
          refreshDatalist();
          // if this was last, remove last_remembered_username
          const lastU = localStorage.getItem('last_remembered_username');
          if (lastU === u) localStorage.removeItem('last_remembered_username');
        }
      });

      // On form submit, if remember is checked, save creds; otherwise ensure removal
      $('#loginForm').on('submit.remember', function(e) {
        // This handler runs alongside the main submit handler defined later.
        const u = usernameInput.value;
        const p = passwordInput.value;
        if (u && rememberCheckbox.checked) {
          remembered[u] = encodePwd(p || '');
          saveRemembered(remembered);
          localStorage.setItem('last_remembered_username', u);
          refreshDatalist();
        } else if (u && !rememberCheckbox.checked) {
          if (remembered[u]) {
            delete remembered[u];
            saveRemembered(remembered);
            refreshDatalist();
          }
          // clear last if it matches
          const lastU = localStorage.getItem('last_remembered_username');
          if (lastU === u) localStorage.removeItem('last_remembered_username');
        }
      });
    });

    $('#loginForm').on('submit', async function(e) {
      e.preventDefault();
      
      const username = $('#username').val();
      const password = $('#password').val();
      const rememberMe = $('#rememberMe').is(':checked');
      
      if (!username || !password) {
        showAlert('Please fill in all fields');
        return;
      }
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });
        
  const data = await response.json();

  // If login succeeded normally
  if (response.ok) {
          // Login successful
          showAlert('Login successful! Redirecting...', 'success');
          
          // Store tokens
          localStorage.setItem('access_token', data.access_token);
          if (data.refresh_token) {
            localStorage.setItem('refresh_token', data.refresh_token);
          }
          
          // Store user info
          if (data.user) {
            localStorage.setItem('user_info', JSON.stringify(data.user));
          }
          
          // Check user role and redirect accordingly
          const userRole = data.user?.role || 'user';
          const redirectUrl = userRole === 'admin' ? '/admin' : '/';
          
          // Redirect to appropriate dashboard after short delay
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1500);
          
              } else {
          // If backend expects 'email' instead of 'username', try fallback once
          if (!response.ok && !this._retriedWithEmail) {
            this._retriedWithEmail = true;
            try {
              const retryResp = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: username, password: password })
              });
              const retryData = await retryResp.json();
              if (retryResp.ok) {
                showAlert('Login successful! Redirecting...', 'success');
                localStorage.setItem('access_token', retryData.access_token);
                if (retryData.refresh_token) localStorage.setItem('refresh_token', retryData.refresh_token);
                if (retryData.user) localStorage.setItem('user_info', JSON.stringify(retryData.user));
                
                // Check user role and redirect accordingly  
                const userRole = retryData.user?.role || 'user';
                const redirectUrl = userRole === 'admin' ? '/admin' : '/';
                setTimeout(() => { window.location.href = redirectUrl; }, 1500);
                return;
              } else {
                // Hide any server-side 'email_not_verified' message on retry and show a generic error instead
                let serverMsg = retryData.message || retryData.error || 'Login failed. Please check your credentials.';
                if (retryData.error === 'email_not_verified') {
                  serverMsg = 'Login failed. Please check your credentials.';
                }
                showAlert(serverMsg);
                return;
              }
            } catch (err) {
              console.error('Retry login error:', err);
            }
          }

          // Login failed â€” show server-provided message or debug_reason if available (dev only)
          console.info('Login failed response:', data);
          // Suppress the explicit "email_not_verified" message in the login UI and show a generic failure message
          let serverMsg;
          if (data.error === 'email_not_verified') {
            serverMsg = 'Login failed. Please check your credentials.';
          } else {
            serverMsg = data.message || data.error || 'Login failed. Please check your credentials.';
          }
          let debugInfo = '';
          if (data.debug_reason) {
            debugInfo = ` (${data.debug_reason})`;
          }
          showAlert(serverMsg + debugInfo);
        }
        
      } catch (error) {
        console.error('Login error:', error);
        showAlert('An error occurred. Please try again.');
      }
    });
  </script>
</body>

</html>
